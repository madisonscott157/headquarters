<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headquarters</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0d1421;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            padding-bottom: 40px;
            min-width: 1800px;
        }

        .container {
            max-width: 1350px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .horse-detail-view .container {
            max-width: 1550px;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        /* Make gallops view wider */
        #gallopView .container {
            max-width: 1650px;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        .horse-detail-view .table-container {
            overflow-x: auto;
            width: 100%;
            margin: 0;
            padding: 10px;
        }
        
        .horse-detail-view table {
            width: 100%;
            min-width: 1400px;
            table-layout: auto;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }

        .file-input {
            margin-right: 20px;
        }

        #fileInput {
            display: none;
        }

        .file-label {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-label:hover {
            background: #2980b9;
        }

        .export-btn {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(52, 73, 94, 0.2);
        }

        .export-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 73, 94, 0.3);
        }

        .export-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .table-container {
            overflow-x: auto;
            padding: 20px;
            width: 100%;
            max-width: 100%;
        }
        
        /* Make ONLY main page table container wider */
        .table-container:has(#horseTable) {
            max-width: 2000px !important;
            margin: 0 auto !important;
            width: 100% !important;
        }
        

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e8eaed;
            table-layout: auto;
            font-size: 13px;
        }

        /* Larger font size for main page table */
        #horseTable {
            font-size: 14px !important;
        }
        
        /* Make sure all table content is larger */
        #horseTable th,
        #horseTable td,
        #horseTable .cell-content,
        #horseTable a {
            font-size: 14px !important;
        }

        th, td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            position: relative;
            overflow: visible;
            white-space: nowrap;
        }
        
        .cell-content {
            position: relative;
            white-space: nowrap;
            overflow: visible;
            z-index: 10;
        }
        
        .horse-detail-view th, .horse-detail-view td {
            padding: 6px 4px;
            font-size: 12px;
            line-height: 1.2;
            vertical-align: top;
            position: relative;
            width: auto;
            max-width: 0;
            overflow: visible;
        }
        
        .horse-detail-view th {
            width: 80px !important;
            min-width: 80px;
            max-width: 80px;
            word-wrap: break-word;
        }
        
        .horse-detail-view .horse-name-cell {
            width: 1%;
            white-space: nowrap;
            text-align: left;
            padding-right: 8px;
        }
        
        .horse-name-cell {
            text-align: left;
            width: 160px;
        }
        
        .horse-name-link {
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .horse-name-link:hover {
            text-decoration: underline;
        }
        
        .fast-recovery-col {
            width: 130px;
        }
        
        .max-speed-col,
        .date-col {
            width: 110px;
        }
        
        .horse-name-col {
            width: 160px;
            min-width: 160px;
            white-space: nowrap;
        }
        
        /* Wider horse names on individual horse detail pages */
        .horse-detail-view .horse-name-col {
            width: 260px;
            min-width: 260px;
        }
        
        .date-col {
            width: 85px;
            min-width: 85px;
        }
        
        .fast-recovery-col {
            width: 90px;
            min-width: 90px;
        }
        
        .max-speed-col {
            width: 80px;
            min-width: 80px;
        }
        
        th {
            width: 70px;
            min-width: 70px;
            font-size: 12px;
            font-weight: 600;
        }
        
        td {
            font-size: 12px;
        }

        th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            cursor: pointer;
            transition: background 0.3s;
            text-align: center;
        }

        th:hover {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        tr:nth-child(even) {
            background: #fafbfc;
        }

        tr:hover {
            background: #e8f4fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        
        .clickable-row {
            cursor: default;
        }

        .sort-indicator {
            margin-left: 5px;
            opacity: 0.7;
        }

        .time-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
        }

        .speed-cell {
            color: #e74c3c;
            font-weight: bold;
        }

        .age-cell {
            color: #8e44ad;
            font-weight: bold;
        }
        
        .recovery-cell {
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }
        
        .recovery15-cell {
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }


        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .lost-numbers {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-family: 'Courier New', 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: #6a9a7b;
            opacity: 0.75;
            font-weight: normal;
            letter-spacing: 2px;
            user-select: none;
            pointer-events: none;
        }
        
        .horse-detail-view {
            display: none;
        }
        
        .back-button {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 15px;
            transition: background 0.3s;
        }
        
        .back-button:hover {
            background: #7f8c8d;
        }
        
        .horse-detail-header {
            background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .horse-detail-header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .workout-row {
            background-color: #fbeaea !important;
        }
        
        .workout-row:hover {
            background-color: #f8e3e3 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 74, 74, 0.1);
        }
        
        .workout-row td {
            background-color: #fbeaea;
            color: #000 !important;
        }
        
        .workout-row:hover td {
            background-color: #f8e3e3;
        }
        
        .workout-row .speed-cell {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        .workout-row .age-cell {
            color: #8e44ad !important;
            font-weight: bold;
        }
        
        .workout-row .time-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50 !important;
        }
        
        .workout-row .recovery-cell {
            font-weight: bold;
            color: #2c3e50 !important;
            text-align: center;
        }
        
        .workout-row .recovery15-cell {
            font-weight: bold;
            color: #2c3e50 !important;
            text-align: center;
        }
        
        .race-row {
            background-color: #e6f3ff !important;
        }
        
        .race-row:hover {
            background-color: #d1e9ff !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.1);
        }
        
        .race-row td {
            background-color: #e6f3ff;
            color: #000 !important;
        }
        
        .race-row:hover td {
            background-color: #d1e9ff;
        }
        
        .race-row .speed-cell {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        .race-row .age-cell {
            color: #8e44ad !important;
            font-weight: bold;
        }
        
        .race-row .time-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50 !important;
        }
        
        .race-row .recovery-cell {
            font-weight: bold;
            color: #2c3e50 !important;
            text-align: center;
        }
        
        .race-row .recovery15-cell {
            font-weight: bold;
            color: #2c3e50 !important;
            text-align: center;
        }
        

        /* Calendar popup styles */
        .calendar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .calendar-popup {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 15px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .calendar-nav-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .calendar-nav-btn:hover {
            background-color: #2980b9;
        }

        .calendar-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .calendar-close:hover {
            color: #e74c3c;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #bdc3c7;
            border: 1px solid #bdc3c7;
        }

        .calendar-day-header {
            background-color: #34495e;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
        }

        .calendar-day {
            background-color: white;
            min-height: 80px;
            padding: 2px;
            position: relative;
            border: 1px solid #ecf0f1;
            display: flex;
            flex-direction: column;
        }

        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #95a5a6;
        }

        .calendar-day-number {
            font-weight: bold;
            font-size: 10px;
            margin-bottom: 2px;
            padding: 2px;
        }

        .calendar-day.has-events .calendar-day-number {
            font-size: 9px;
            margin-bottom: 1px;
        }

        .calendar-event {
            font-size: 10px;
            padding: 3px 4px;
            margin-bottom: 1px;
            border-radius: 3px;
            line-height: 1.3;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
        }

        .calendar-event.gallop {
            background-color: #fbeaea;
            color: #8e44ad;
            border-left: 3px solid #e74c3c;
        }

        .calendar-event.race {
            background-color: #e6f3ff;
            color: #2980b9;
            border-left: 3px solid #3498db;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            table {
                font-size: 11px;
            }
            
            /* Keep main page table larger on medium screens */
            #horseTable {
                font-size: 15px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            th {
                font-size: 11px;
            }
            
            td {
                font-size: 11px;
            }
            
            .horse-name-col {
                width: 140px;
                min-width: 140px;
                white-space: nowrap;
            }
            
            .horse-detail-view .horse-name-col {
                width: 220px;
                min-width: 220px;
            }
            
            .date-col {
                width: 75px;
                min-width: 75px;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
            
            table {
                font-size: 10px;
            }
            
            /* Keep main page table larger on small screens */
            #horseTable {
                font-size: 14px;
            }
            
            th, td {
                padding: 6px 8px;
            }
            
            .horse-name-col {
                width: 120px;
                min-width: 120px;
                white-space: nowrap;
            }
            
            .horse-detail-view .horse-name-col {
                width: 200px;
                min-width: 200px;
            }
            
            .date-col {
                width: 60px;
                min-width: 60px;
            }
            
            .fast-recovery-col, .max-speed-col {
                width: 60px;
                min-width: 60px;
            }
            
            th {
                width: 50px;
                min-width: 50px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainView">
        <div class="header">
            <h1>Headquarters</h1>
            <p style="font-size: 1.6em; margin: -5px 0 5px 0;">üöÄ</p>
            <p>Analyze horse performance data with interactive sorting and filtering</p>
        </div>


        <div class="controls">
            <div class="control-group file-input">
                <label for="fileInput" class="file-label">üìÅ Upload Excel File</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.csv">
            </div>
            
            <div class="control-group">
                <label for="horseFilter">Filter by Horse:</label>
                <input type="text" id="horseFilter" list="horseList" placeholder="Type or select horse name...">
                <datalist id="horseList">
                </datalist>
            </div>
            
            <div class="control-group">
                <label for="ageFilter">Filter by Age:</label>
                <select id="ageFilter">
                    <option value="">All Ages</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="viewFilter" style="font-weight: bold;">View:</label>
                <select id="viewFilter" onchange="changeView()">
                    <option value="best5f">Best 5F Time</option>
                    <option value="best1f">Best 1F Time</option>
                    <option value="maxSpeed">Max Speed</option>
                    <option value="worstFastRecovery">Highest Fast Recovery</option>
                    <option value="worst15minRecovery">Highest 15 Min Recovery</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="gallopBtn" onclick="showGallopsView()" style="padding: 8px 16px; font-size: 14px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Gallops</button>
            </div>
            
            <div class="control-group">
                <button id="exportCsv" class="export-btn" disabled>üìä Export as CSV</button>
            </div>
        </div>

        <div class="table-container">
            <table id="horseTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('name')" class="horse-name-col">Horse <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('age')">Age <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('group')">Group <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('lastGallop')" class="date-col">Last Gallop <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('lastRace')" class="date-col">Last Race <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('valeur')" class="date-col">Valeur <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('dateOfBest5f')" class="date-col">Date of Best 5F <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('best1f')">Time 1F <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('best5f')">Best 5F <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('fastRecovery')" class="fast-recovery-col">Fast Recovery <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('recovery15min')">15 min <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortTable('maxSpeed')" class="max-speed-col">Max Speed <span class="sort-indicator">‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="horseTableBody">
                    <tr>
                        <td colspan="12" class="no-data">No data loaded. Please upload Excel files to get started.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Horse Detail View -->
    <div class="horse-detail-view" id="horseDetailView">
    <div class="container">
        <div class="horse-detail-header">
            <h1 id="horseDetailTitle">Horse Details</h1>
        </div>

        <div class="controls">
            <button class="back-button" onclick="backToMain()">‚Üê Back to Main</button>
            
            <div class="control-group">
                <label for="horseAgeFilter">Filter by Age:</label>
                <select id="horseAgeFilter">
                    <option value="">All Ages</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="horseWorkoutFilter">Filter by Type:</label>
                <select id="horseWorkoutFilter">
                    <option value="all">All Training</option>
                    <option value="gallops">Gallops Only</option>
                    <option value="races">Races Only</option>
                    <option value="gallops-races">Gallops and Races Only</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="horseSortBy">Sort by:</label>
                <select id="horseSortBy">
                    <option value="date">Date</option>
                    <option value="distance">Distance du travail</option>
                    <option value="maxSpeed">Vitesse maximale</option>
                    <option value="avgSpeed">Vitesse moyenne du travail</option>
                    <option value="best200m">Meilleurs 200m</option>
                    <option value="best800m">Meilleurs 800m</option>
                    <option value="best1000m">Meilleurs 1000m</option>
                    <option value="maxHeartRate">Fr√©quence cardiaque maximale</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="horseSortOrder">Order:</label>
                <select id="horseSortOrder">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="exportHorseCsv" class="export-btn">üìä Export Horse Data</button>
                <button id="showCalendar" class="export-btn" onclick="showCalendarPopup()">üìÖ Calendrier</button>
            </div>
        </div>

        <div class="table-container">
            <table id="horseDetailTable">
                <thead>
                    <tr>
                        <th onclick="sortHorseTable('date')">Date <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('cheval')">Cheval <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('age')">√Çge <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('distance')">Distance<br>du travail <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('maxSpeed')">Vitesse<br>maximale <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('avgSpeed')">Vitesse moyenne<br>du travail <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('best200m')">Meilleurs<br>200m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('best800m')">Meilleurs<br>800m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('best1000m')">Meilleurs<br>1000m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('maxHeartRate')">Fr√©quence cardiaque<br>maximale <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('recovery')">R√©cup√©ration<br>apr√®s l'effort <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('recovery15min')">15 min<br>r√©cup√©ration <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('heartRateReturn')">Fr√©quence cardiaque<br>au retour <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('amplitude35')">Amplitude<br>√† 35 km/h <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('effort1')">Temps zone<br>effort 1 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('effort2')">Temps zone<br>effort 2 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('effort3')">Temps zone<br>effort 3 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('effort4')">Temps zone<br>effort 4 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortHorseTable('effort5')">Temps zone<br>effort 5 <span class="sort-indicator">‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="horseDetailTableBody">
                    <tr>
                        <td colspan="19" class="no-data">No data loaded for this horse.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <!-- Gallops Comparison View -->
    <div id="gallopView" class="horse-detail-view" style="display: none;">
        <div class="detail-header">
            <h2 id="gallopViewTitle" class="detail-title" style="color: white;">Gallops Comparison - [Date]</h2>
            <p style="margin: 5px 0; color: #ccc; font-size: 14px;" id="gallopViewSubtitle">All horses that galloped on this date</p>
        </div>
        
        <div class="container" style="margin-top: 0; padding-top: 20px;">
            <div class="detail-controls" style="margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
                <div class="control-group">
                    <label for="gallopDateFilter">Date de Galop:</label>
                    <select id="gallopDateFilter" onchange="changeGallopDate()">
                        <!-- Dates will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="control-group">
                    <button onclick="backToMainFromGallops()" class="back-button">‚Üê Back to Main</button>
                </div>
                
                <div class="control-group">
                    <button onclick="exportGallopsCsv()" class="export-btn">üìä Export as CSV</button>
                </div>
                
                <div class="control-group">
                </div>
            </div>
            <div class="table-container">
            <table id="gallopTable">
                <thead>
                    <tr>
                        <th onclick="sortGallopTable('horse')" class="horse-name-col" style="cursor: pointer; width: 140px; min-width: 140px; white-space: nowrap;">Cheval <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('age')" style="cursor: pointer;">√Çge <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('group')" style="cursor: pointer;">Group <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('distance')" style="cursor: pointer;">Distance<br>du travail <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('maxSpeed')" style="cursor: pointer;">Vitesse<br>maximale <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('avgSpeed')" style="cursor: pointer;">Vitesse moyenne<br>du travail <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('best200m')" style="cursor: pointer;">Meilleurs<br>200m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('best800m')" style="cursor: pointer;">Meilleurs<br>800m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('best5f')" style="cursor: pointer;">Meilleurs<br>1000m <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('maxHeartRate')" style="cursor: pointer;">Fr√©quence cardiaque<br>maximale atteinte <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('fastRecovery')" style="cursor: pointer;">R√©cup√©ration<br>apr√®s l'effort <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('recovery15min')" style="cursor: pointer;">15 min<br>r√©cup√©ration <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('heartRateReturn')" style="cursor: pointer;">Fr√©quence cardiaque<br>au retour <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('amplitude35')" style="cursor: pointer;">Amplitude<br>√† 35 km/h <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('effort1')" style="cursor: pointer;">Temps zone<br>effort 1 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('effort2')" style="cursor: pointer;">Temps zone<br>effort 2 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('effort3')" style="cursor: pointer;">Temps zone<br>effort 3 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('effort4')" style="cursor: pointer;">Temps zone<br>effort 4 <span class="sort-indicator">‚Üï</span></th>
                        <th onclick="sortGallopTable('effort5')" style="cursor: pointer;">Temps zone<br>effort 5 <span class="sort-indicator">‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="gallopTableBody">
                    <!-- Gallop data will be populated here -->
                </tbody>
            </table>
            </div>
        </div>
    </div>


    <!-- Calendar Popup -->
    <div class="calendar-overlay" id="calendarOverlay">
        <div class="calendar-popup">
            <button class="calendar-close" onclick="hideCalendarPopup()">&times;</button>
            
            <div class="calendar-header">
                <div class="calendar-title" id="calendarTitle">Calendrier d'Entra√Ænement</div>
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" onclick="previousMonth()" style="padding: 4px 8px; font-size: 12px;">‚Üê Pr√©c√©dent</button>
                    <div id="currentMonthYear" style="font-weight: bold; font-size: 18px;"></div>
                    <button class="calendar-nav-btn" onclick="nextMonth()" style="padding: 4px 8px; font-size: 12px;">Suivant ‚Üí</button>
                    <button class="calendar-nav-btn" onclick="exportCalendarToPDF()" style="background-color: #2196F3; color: white; padding: 4px 8px; font-size: 12px;">Export PDF</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>
        </div>
    </div>

    <script>
        let horseData = [];
        let filteredData = [];
        let currentSort = { column: 'name', order: 'asc' };
        let allHorseDetailData = {};
        let currentHorseDetailData = [];
        let currentHorseDetailSort = { column: 'date', order: 'desc' };
        let horseColorMapping = {}; // Maps horse names to their color group
        let currentWorkbook = null;
        let greenHorses = []; // Column C horses (Group A)
        let orangeHorses = []; // Column D horses (Group B)  
        let lightRedHorses = []; // Column E horses (Group C)
        
        function processSheet2ColorMapping() {
            console.log('=== SIMPLE Sheet2 Reading ===');
            
            if (!currentWorkbook || !currentWorkbook.Sheets['Sheet2']) {
                console.log('No Sheet2 found, skipping color mapping');
                greenHorses = [];
                orangeHorses = [];
                lightRedHorses = [];
                horseColorMapping = {};
                return;
            }
            
            // Clear arrays
            greenHorses = [];
            orangeHorses = [];
            lightRedHorses = [];
            horseColorMapping = {};
            
            const sheet = currentWorkbook.Sheets['Sheet2'];
            
            console.log('Sheet2 range:', sheet['!ref']);
            console.log('Checking direct cell access:');
            
            // Check what's actually in the cells directly
            for (let row = 1; row <= 5; row++) {
                console.log(`Direct cell access for row ${row}:`);
                console.log(`  A${row}:`, sheet[`A${row}`] ? sheet[`A${row}`].v : 'empty');
                console.log(`  B${row}:`, sheet[`B${row}`] ? sheet[`B${row}`].v : 'empty');
                console.log(`  C${row}:`, sheet[`C${row}`] ? sheet[`C${row}`].v : 'empty');
                console.log(`  D${row}:`, sheet[`D${row}`] ? sheet[`D${row}`].v : 'empty');
                console.log(`  E${row}:`, sheet[`E${row}`] ? sheet[`E${row}`].v : 'empty');
            }
            
            // Now read using direct cell access instead of JSON conversion
            const startRow = 2; // Skip header
            let row = startRow;
            
            // Read horses using direct cell access
            console.log('Reading horses from columns C, D, E using direct cell access...');
            
            while (true) {
                const cellC = sheet[`C${row}`];
                const cellD = sheet[`D${row}`];
                const cellE = sheet[`E${row}`];
                
                // If all cells are empty, we've reached the end
                if (!cellC && !cellD && !cellE) {
                    break;
                }
                
                // Column C - Group A (Green)
                if (cellC && cellC.v) {
                    const name = cellC.v.toString().trim().toUpperCase();
                    if (name) {
                        greenHorses.push(name);
                        horseColorMapping[name] = 'green';
                        if (row <= 6) console.log(`  Added to GROUP A (GREEN) from Column C${row}: "${name}"`);
                    }
                }
                
                // Column D - Group B (Orange)
                if (cellD && cellD.v) {
                    const name = cellD.v.toString().trim().toUpperCase();
                    if (name) {
                        orangeHorses.push(name);
                        horseColorMapping[name] = 'orange';
                        if (row <= 6) console.log(`  Added to GROUP B (ORANGE) from Column D${row}: "${name}"`);
                    }
                }
                
                // Column E - Group C (Light Red)
                if (cellE && cellE.v) {
                    const name = cellE.v.toString().trim().toUpperCase();
                    if (name) {
                        lightRedHorses.push(name);
                        horseColorMapping[name] = 'light-red';
                        if (row <= 6) console.log(`  Added to GROUP C (LIGHT RED) from Column E${row}: "${name}"`);
                    }
                }
                
                row++;
                
                // Safety check to prevent infinite loop
                if (row > 1000) break;
            }
            
            console.log('=== SHEET2 VERIFICATION ===');
            console.log('A Group (Green) - Count:', greenHorses.length, 'First 3:', greenHorses.slice(0, 3));
            console.log('B Group (Orange) - Count:', orangeHorses.length, 'First 3:', orangeHorses.slice(0, 3));
            console.log('C Group (Light Red) - Count:', lightRedHorses.length, 'First 3:', lightRedHorses.slice(0, 3));
            
            // Test a few specific horses to verify lookup works
            console.log('=== GROUP LOOKUP VERIFICATION ===');
            if (greenHorses.length > 0) {
                const testGreen = greenHorses[0];
                console.log(`Test Green Horse: "${testGreen}" -> Group: ${getHorseGroup(testGreen)}`);
            }
            if (orangeHorses.length > 0) {
                const testOrange = orangeHorses[0];
                console.log(`Test Orange Horse: "${testOrange}" -> Group: ${getHorseGroup(testOrange)}`);
            }
            if (lightRedHorses.length > 0) {
                const testRed = lightRedHorses[0];
                console.log(`Test Light Red Horse: "${testRed}" -> Group: ${getHorseGroup(testRed)}`);
            }
        }
        
        function getHorseNameColor(horseName) {
            const group = getHorseGroup(horseName);
            if (!group || group === '-') return '';
            
            // Use the "most forward" color (highest priority)
            // A (green) > B (orange) > C (light red)
            if (group.includes('A')) {
                return 'background-color: #d4edda; color: #000;'; // Green wins
            } else if (group.includes('B')) {
                return 'background-color: #fff3cd; color: #000;'; // Orange wins  
            } else if (group.includes('C')) {
                return 'background-color: #f8d7da; color: #000;'; // Light red
            }
            
            return '';
        }
        
        function getHorseGroup(horseName) {
            // Use the dynamically loaded global arrays from Sheet2
            const groups = [];
            
            // Convert to uppercase for comparison since we store them as uppercase
            const upperCaseName = horseName.toUpperCase();
            
            if (greenHorses.includes(upperCaseName)) groups.push('A');
            if (orangeHorses.includes(upperCaseName)) groups.push('B'); 
            if (lightRedHorses.includes(upperCaseName)) groups.push('C');
            
            const result = groups.length > 0 ? groups.join('/') : '-';
            
            return result;
        }
        
        function getFastRecoveryColor(value) {
            if (!value || value === 'N/A') return null;
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return null;
            
            if (numValue >= 140) return '#fdeaea';
            if (numValue >= 125) return '#fff3cd';
            if (numValue >= 119) return '#f9f7e3';
            if (numValue >= 101) return '#d4edda';
            return '#d1ecf1';
        }
        
        function getRecovery15Color(value) {
            if (!value || value === 'N/A') return null;
            
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return null;
            
            if (numValue >= 116) return '#fdeaea';
            if (numValue >= 102) return '#fff3cd';
            if (numValue >= 81) return '#d4edda';
            return '#d1ecf1';
        }
        
        function get1000mTimeColor(timeStr) {
            if (!timeStr || timeStr === 'N/A' || !isValidTime(timeStr)) return null;
            
            const seconds = timeToSeconds(timeStr);
            
            if (seconds < 63) return '#d1ecf1';     // Blue - below 1:03.00
            if (seconds < 71) return '#d4edda';     // Green - 1:03.00 to 1:11.00
            if (seconds < 110) return '#f9f7e3';   // Light yellow - 1:11.00 to 1:50.00
            return '#fdeaea';                       // Red - 1:50.00 and higher
        }

        console.log("üêé Horse Racing Analyzer loaded successfully!");
        
        // France Galop URL generation functions
        function generateRaceUrl(date, track) {
            // For France Galop race detail pages
            // Pattern: https://www.france-galop.com/fr/course/detail/YYYY/P/[encoded-id]
            // Since we can't determine the exact encoded ID, we'll use a simplified approach
            // that at least gets users to the right date/track area
            
            if (!date || !track) return null;
            
            const year = new Date(date).getFullYear();
            // This is a simplified URL - the actual encoded ID would need to be extracted from the original Excel
            // For now, this gets users to France Galop races for the year
            return `https://www.france-galop.com/fr/course/programmes?date=${date}&hippodrome=${track}`;
        }
        
        function generateTrackingReportUrl(date, track, raceNumber) {
            // For France Galop tracking reports
            // Pattern: https://www7.france-galop.com/Casaques/Tracking/YYYYMMDDXXX##_last_times_fr.pdf
            
            if (!date || !track) return null;
            
            const dateObj = new Date(date);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // Map track names to codes (add more as needed)
            const trackCodes = {
                'deauville': 'DEA',
                'saint-cloud': 'SCL',
                'longchamp': 'LON',
                'chantilly': 'CHA',
                'maisons-laffitte': 'MAL'
            };
            
            const trackCode = trackCodes[track.toLowerCase()] || 'DEA';
            const raceNum = raceNumber || '02'; // Default to race 2 if not specified
            
            return `https://www7.france-galop.com/Casaques/Tracking/${dateStr}${trackCode}${raceNum}_last_times_fr.pdf`;
        }
        
        function extractTrackFromRecoveryText(recoveryText) {
            // Extract track name from race result text
            if (!recoveryText || typeof recoveryText !== 'string') return null;
            
            const trackIndicators = ['deauville', 'saint-cloud', 'longchamp', 'chantilly', 'maisons-laffitte'];
            const lowerText = recoveryText.toLowerCase();
            
            return trackIndicators.find(track => lowerText.includes(track)) || null;
        }
        
        function extractRaceNumberFromText(recoveryText) {
            // Try to extract race number from text like "G3" or "C1" etc.
            if (!recoveryText || typeof recoveryText !== 'string') return '02';
            
            const match = recoveryText.match(/([GC]\d+)/i);
            return match ? '0' + match[1].charAt(1) : '02';
        }
        
        function cleanNCValue(value) {
            // Replace N/C (case insensitive) with dash
            if (value === 'N/C' || value === 'n/c' || value === 'N/c' || value === 'n/C') {
                return '-';
            }
            return value || '-';
        }
        
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('horseFilter').addEventListener('input', filterData);
        document.getElementById('ageFilter').addEventListener('change', filterData);
        document.getElementById('exportCsv').addEventListener('click', exportToCsv);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('File selected:', file.name);
            horseData = [];
            
            // Clear previous workbook and color mapping data
            currentWorkbook = null;
            const prevGreenCount = greenHorses.length;
            const prevOrangeCount = orangeHorses.length;
            const prevRedCount = lightRedHorses.length;
            greenHorses = [];
            orangeHorses = [];
            lightRedHorses = [];
            horseColorMapping = {};
            console.log(`=== DATA CLEARING VERIFICATION ===`);
            console.log(`Cleared previous data: Green(${prevGreenCount}), Orange(${prevOrangeCount}), Red(${prevRedCount})`);
            console.log('Arrays now empty:', greenHorses.length === 0 && orangeHorses.length === 0 && lightRedHorses.length === 0);
            
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv');
            
            reader.onload = function(e) {
                if (isCSV) {
                    const csvText = e.target.result;
                    const jsonData = parseCSV(csvText);
                    const horseName = fileName.replace('.csv', '').replace(/[^a-zA-Z0-9]/g, ' ').trim() || 'Horse';
                    const horseStats = processSheetData(jsonData, horseName, null, null);
                    if (horseStats) {
                        horseData.push(horseStats);
                    }
                } else {
                    try {
                        const data = new Uint8Array(e.target.result);
                        currentWorkbook = XLSX.read(data, {
                            type: 'array', 
                            cellStyles: true, 
                            cellHTML: true,
                            cellFormula: true, 
                            bookSST: true,
                            cellNF: true,
                            cellDates: true,
                            raw: false
                        });
                        
                        console.log('Workbook loaded. Sheet names:', currentWorkbook.SheetNames);
                        
                        currentWorkbook.SheetNames.forEach(sheetName => {
                            const sheetNameLower = sheetName.toLowerCase();
                            if (sheetNameLower === 'sheet1' || sheetNameLower === 'sheet2' || sheetNameLower === 'buttons') {
                                return;
                            }
                            
                            const worksheet = currentWorkbook.Sheets[sheetName];
                            if (!worksheet) return;
                            
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                            const horseStats = processSheetData(jsonData, sheetName, worksheet, currentWorkbook);
                            if (horseStats) {
                                horseData.push(horseStats);
                            }
                        });
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        alert('Error processing Excel file: ' + error.message);
                        return;
                    }
                }
                
                // Process Sheet2 for horse color mapping (works for Excel files with Sheet2)
                if (currentWorkbook && currentWorkbook.Sheets['Sheet2']) {
                    console.log('>>> ABOUT TO CALL processSheet2ColorMapping()');
                    processSheet2ColorMapping();
                    console.log('>>> FINISHED CALLING processSheet2ColorMapping()');
                    
                    // Force complete table rebuild to show updated groups
                    console.log('>>> REBUILDING TABLE TO SHOW GROUPS');
                    console.log('Horse data count before update:', horseData.length);
                    
                    // Update all existing horse data with new group information
                    let updatedCount = 0;
                    horseData.forEach(horse => {
                        const oldGroup = horse.group;
                        horse.group = getHorseGroup(horse.name);
                        if (oldGroup !== horse.group) {
                            updatedCount++;
                        }
                    });
                    
                    console.log(`Updated ${updatedCount} horses with new group assignments`);
                    
                    // Force table refresh
                    filterData();
                } else {
                    console.log('Sheet2 not available - using default color mapping');
                    // Initialize empty arrays for CSV files or Excel files without Sheet2
                    greenHorses = [];
                    orangeHorses = [];
                    lightRedHorses = [];
                    horseColorMapping = {};
                }
                
                updateHorseFilter();
                updateAgeFilter();
                filterData();
                document.getElementById('exportCsv').disabled = false;
            };
            
            if (isCSV) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    row.push(current.trim());
                    result.push(row);
                }
            }
            
            return result;
        }
        
        function processSheetData(jsonData, horseName, worksheet, workbook) {
            if (jsonData.length === 0) return null;
            
            const headers = jsonData[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            console.log(`Processing sheet: ${horseName}`);
            
            let age = null;
            let best1f = null;
            let best5f = null;
            let dateOfBest5f = null;
            let dateOfBest1f = null;
            let best1fRecovery = null;
            let best1fRecovery15min = null;
            let best1fRecoveryColor = null;
            let best1fRecovery15Color = null;
            let best1fCorresponding5f = null;
            let best1fMaxSpeed = null;
            let best5fMaxSpeed = null;
            let best5fCorresponding1f = null;
            let maxSpeed = null;
            let dateOfMaxSpeed = null;
            let maxSpeedRecovery = null;
            let maxSpeedRecovery15min = null;
            let maxSpeedRecoveryColor = null;
            let maxSpeedRecovery15Color = null;
            let maxSpeedCorresponding1f = null;
            let maxSpeedCorresponding5f = null;
            let fastRecovery = null;
            let recovery15min = null;
            let fastRecoveryColor = null;
            let recovery15Color = null;
            
            const times1f = [];
            const times5f = [];
            const speeds = [];
            const maxSpeeds = [];
            const detailData = [];
            const gallopDates = [];
            const raceDates = [];
            const raceValeurs = []; // Store {date, valeur} for races
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;
                
                const rowData = {};
                headers.forEach((header, index) => {
                    rowData[header] = row[index] ? row[index].toString().trim() : '';
                });
                
                let dateValue = row[0] || rowData.date || rowData.timestamp || rowData['race date'] || '';
                if (typeof dateValue === 'number' && dateValue > 40000) {
                    const excelEpoch = new Date(1899, 11, 30);
                    const jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                    dateValue = jsDate.toLocaleDateString();
                } else if (dateValue instanceof Date) {
                    dateValue = dateValue.toLocaleDateString();
                } else if (dateValue.toString().includes('T')) {
                    const date = new Date(dateValue);
                    dateValue = date.toLocaleDateString();
                }
                
                // No gallop detection - removed as requested
                
                // Check for hyperlinks in date and horse name cells
                let dateHyperlink = null;
                let horseHyperlink = null;
                
                if (worksheet && worksheet['!ref']) {
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    // Check date cell (first column)
                    const dateCell = worksheet[XLSX.utils.encode_cell({r: i, c: 0})];
                    if (dateCell && dateCell.l) {
                        dateHyperlink = dateCell.l.Target || dateCell.l.target;
                    }
                    
                    // Check horse name cell (second column)
                    const horseCell = worksheet[XLSX.utils.encode_cell({r: i, c: 1})];
                    if (horseCell && horseCell.l) {
                        horseHyperlink = horseCell.l.Target || horseCell.l.target;
                    }
                }
                
                // Detect workouts and race results based on multiple criteria
                let isWorkout = false;
                let isRaceResult = false;
                
                const distance = parseFloat(rowData['distance du travail'] || rowData['distance'] || '0');
                const maxSpeed = parseFloat(rowData['vitesse maximale'] || rowData['max speed'] || '0');
                const recovery = (rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '').toString().toLowerCase();
                const maxHeartRate = parseFloat(rowData['fr√©quence cardiaque maximale atteinte'] || rowData['max heart rate'] || '0');
                const avgSpeed = parseFloat(rowData['vitesse moyenne du travail'] || rowData['avg speed'] || '0');
                
                // Simplified race detection logic - focus on hyperlinks and recovery text patterns
                
                // 1. If there's a hyperlink, it's definitely a race
                if (dateHyperlink || horseHyperlink) {
                    isRaceResult = true;
                }
                
                // 2. Check fast recovery column for race indicators
                // Define race patterns outside the if block for debugging
                const racePatterns = [
                    // Track names
                    /\b(deauville|saint-cloud|vichy|longchamp|chantilly|maisons-laffitte|lyon-parilly|compiegne|fontainebleau)\b/i,
                    // Race classifications
                    /\b(c[1-5]|g[1-3]|l|prix|listed|group)\b/i,
                    // Finishing positions (number followed by position indicator)
                    /\b(\d+)(er|√®me|st|nd|rd|th)\b/i,
                    // Race result terms
                    /\b(gagn√©|gagnant|plac√©|arriv√©|course|psf|turf)\b/i,
                    // Distance + track combination (e.g. "1200 deauville")
                    /\d{4}\s+\w+/
                ];
                
                if (!isRaceResult && recovery && recovery.trim() !== '') {
                    // Check if recovery text contains race-specific patterns (not just a plain number)
                    const containsRaceText = racePatterns.some(pattern => pattern.test(recovery));
                    const isJustNumber = /^\d+(\.\d+)?$/.test(recovery.trim()); // Just a plain number
                    
                    if (containsRaceText && !isJustNumber) {
                        isRaceResult = true;
                    }
                }
                
                // Debug logging for specific horses/dates mentioned by user
                if ((horseName && (horseName.toLowerCase().includes('just inspiration') || horseName.toLowerCase().includes('rock of rosha'))) ||
                    (dateValue && (dateValue.includes('8/2') || dateValue.includes('8/25') || dateValue.includes('02/08') || dateValue.includes('25/08')))) {
                    console.log(`Race detection for ${horseName} on ${dateValue}:`);
                    console.log(`  - Recovery text: "${recovery}"`);
                    console.log(`  - Has dateHyperlink: ${!!dateHyperlink}`);
                    console.log(`  - Has horseHyperlink: ${!!horseHyperlink}`);
                    console.log(`  - Contains race patterns: ${recovery ? racePatterns.some(pattern => pattern.test(recovery)) : false}`);
                    console.log(`  - Is just number: ${recovery ? /^\d+(\.\d+)?$/.test(recovery.trim()) : false}`);
                    console.log(`  - Detected as race: ${isRaceResult}`);
                }
                
                if (!isRaceResult && distance > 0) {
                    // Primary: Distance-based detection (gallops are basically always over 1600m)
                    if (distance >= 1600) {
                        // Check if it's a slow workout that should be excluded
                        const best200m = rowData['meilleurs 200m'] || rowData['best 200m'] || rowData['best 1f'] || '';
                        const best1000m = rowData['meilleurs 1000m'] || rowData['best 1000m'] || rowData['best 5f'] || '';
                        
                        let isSlowWorkout = false;
                        
                        // Check if fastest 200m is over 15 seconds
                        if (best200m && best200m !== 'N/C' && best200m !== '-') {
                            const time200m = parseTimeToSeconds(best200m);
                            if (time200m && time200m > 15) {
                                isSlowWorkout = true;
                            }
                        }
                        
                        // Check if 5F (1000m) time is over 1:45 (105 seconds)
                        if (!isSlowWorkout && best1000m && best1000m !== 'N/C' && best1000m !== '-') {
                            const time1000m = parseTimeToSeconds(best1000m);
                            if (time1000m && time1000m > 105) {
                                isSlowWorkout = true;
                            }
                        }
                        
                        // Only mark as workout if it's not a slow workout
                        if (!isSlowWorkout) {
                            isWorkout = true;
                        }
                    }
                }

                const detailRow = {
                    date: dateValue,
                    cheval: horseName,
                    age: rowData.age || rowData['√¢ge'] || '',
                    distance: rowData['distance du travail'] || rowData['distance'] || '',
                    maxSpeed: rowData['vitesse maximale'] || rowData['max speed'] || '',
                    avgSpeed: rowData['vitesse moyenne du travail'] || rowData['avg speed'] || '',
                    best200m: rowData['meilleurs 200m'] || rowData['best 200m'] || rowData['best 1f'] || '',
                    best800m: rowData['meilleurs 800m'] || rowData['best 800m'] || rowData['best 4f'] || '',
                    best1000m: rowData['meilleurs 1000m'] || rowData['best 1000m'] || rowData['best 5f'] || '',
                    maxHeartRate: rowData['fr√©quence cardiaque maximale atteinte durant l\'entra√Ænement'] || rowData['max heart rate'] || '',
                    recovery: rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '',
                    recovery15min: rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration'] || rowData['15 recovery'] || '',
                    heartRateReturn: rowData['fr√©quence cardiaque au retour'] || rowData['heart rate return'] || '',
                    amplitude35: rowData['amplitude √† 35 km/h'] || rowData['amplitude 35'] || '',
                    effort1: rowData['temps zone effort 1'] || rowData['effort zone 1'] || '',
                    effort2: rowData['temps zone effort 2'] || rowData['effort zone 2'] || '',
                    effort3: rowData['temps zone effort 3'] || rowData['effort zone 3'] || '',
                    effort4: rowData['temps zone effort 4'] || rowData['effort zone 4'] || '',
                    effort5: rowData['temps zone effort 5'] || rowData['effort zone 5'] || '',
                    isBoldRed: isWorkout,
                    isRaceResult: isRaceResult,
                    dateHyperlink: dateHyperlink,
                    horseHyperlink: horseHyperlink
                };
                
                if (detailRow.date || detailRow.distance || detailRow.maxSpeed || detailRow.best200m || detailRow.best1000m) {
                    detailData.push(detailRow);
                    
                    // Collect gallop and race dates, plus race valeurs
                    if (detailRow.date) {
                        const rowDate = new Date(detailRow.date);
                        const currentDate = new Date();
                        currentDate.setHours(23, 59, 59, 999); // Set to end of today to include today's events
                        
                        if (isWorkout) {
                            gallopDates.push(rowDate);
                        } else if (isRaceResult && rowDate <= currentDate) {
                            // Only include races that have already happened (not future races)
                            raceDates.push(rowDate);
                            
                            // Extract Valeur from race row's max heart rate (should be under 60)
                            const maxHeartRate = parseFloat(detailRow.maxHeartRate);
                            if (maxHeartRate && maxHeartRate < 60) {
                                raceValeurs.push({
                                    date: rowDate,
                                    valeur: maxHeartRate
                                });
                            }
                        }
                    }
                }
                
                // Get age
                if (!age) {
                    const ageValue = rowData.age || rowData['√¢ge'];
                    if (ageValue) {
                        const parsedAge = parseInt(ageValue);
                        if (!isNaN(parsedAge)) {
                            age = parsedAge;
                        }
                    }
                }
                
                // Exclude race results from main page calculations (but still collect race dates)
                if (!isRaceResult) {
                    // Check for 1F times
                    const oneF = rowData['best 1f'] || rowData['meilleurs 200m'] || rowData['1f'] || rowData['1 f'] || rowData['1furlong'];
                    if (oneF && isValidTime(oneF)) {
                        const fastRecoveryValue = rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '';
                        const recovery15Value = rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration'] || rowData['15 recovery'] || '';
                        const fiveF = rowData['best 5f'] || rowData['meilleurs 1000m'] || rowData['5f'] || rowData['5 f'] || rowData['5furlong'];
                        
                        const fastRecoveryColor = getFastRecoveryColor(fastRecoveryValue);
                        const recovery15Color = getRecovery15Color(recovery15Value);
                        
                        times1f.push({ 
                            time: oneF, 
                            seconds: timeToSeconds(oneF),
                            date: dateValue.toString(),
                            fastRecovery: fastRecoveryValue,
                            recovery15min: recovery15Value,
                            fastRecoveryColor: fastRecoveryColor,
                            recovery15Color: recovery15Color,
                            corresponding5f: fiveF,
                            maxSpeed: maxSpeed || null
                        });
                    }
                    
                    // Check for 5F times
                    const fiveF = rowData['best 5f'] || rowData['meilleurs 1000m'] || rowData['5f'] || rowData['5 f'] || rowData['5furlong'];
                    if (fiveF && isValidTime(fiveF)) {
                        const fastRecoveryValue = rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '';
                        const recovery15Value = rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration'] || rowData['15 recovery'] || '';
                        
                        const fastRecoveryColor = getFastRecoveryColor(fastRecoveryValue);
                        const recovery15Color = getRecovery15Color(recovery15Value);
                        
                        // Get corresponding 1F time from the same session
                        const oneF = rowData['best 1f'] || rowData['meilleurs 200m'] || rowData['1f'] || rowData['1 f'] || rowData['200m'];
                        
                        times5f.push({ 
                            time: fiveF, 
                            seconds: timeToSeconds(fiveF),
                            date: dateValue.toString(),
                            fastRecovery: fastRecoveryValue,
                            recovery15min: recovery15Value,
                            fastRecoveryColor: fastRecoveryColor,
                            recovery15Color: recovery15Color,
                            maxSpeed: maxSpeed || null,
                            corresponding1f: oneF
                        });
                    }
                    
                    // Check for speed
                    const speedColumns = ['max speed', 'vitesse maximale', 'avg speed', 'speed', 'maximum speed', 'top speed', 'mph', 'max mph'];
                    for (const col of speedColumns) {
                        if (rowData[col]) {
                            const speed = parseFloat(rowData[col]);
                            if (!isNaN(speed)) {
                                speeds.push(speed);
                                
                                // For max speeds, also collect corresponding training data
                                const oneF = rowData['best 1f'] || rowData['meilleurs 200m'] || rowData['1f'] || rowData['1 f'] || rowData['200m'];
                                const fiveF = rowData['best 5f'] || rowData['meilleurs 1000m'] || rowData['5f'] || rowData['5 f'] || rowData['5furlong'];
                                
                                // Get recovery values from current row
                                const currentFastRecovery = (rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '').toString().toLowerCase();
                                const currentRecovery15 = (rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration'] || rowData['15 recovery'] || '').toString();
                                
                                const fastRecoveryColor = getFastRecoveryColor(currentFastRecovery);
                                const recovery15Color = getRecovery15Color(currentRecovery15);
                                
                                maxSpeeds.push({ 
                                    speed: speed,
                                    date: dateValue.toString(),
                                    fastRecovery: currentFastRecovery,
                                    recovery15min: currentRecovery15,
                                    fastRecoveryColor: fastRecoveryColor,
                                    recovery15Color: recovery15Color,
                                    corresponding1f: oneF,
                                    corresponding5f: fiveF
                                });
                            }
                        }
                    }
                }
            }
            
            if (times1f.length > 0) {
                const fastest1f = times1f.reduce((min, current) => 
                    current.seconds < min.seconds ? current : min
                );
                best1f = fastest1f.time;
                dateOfBest1f = fastest1f.date;
                best1fRecovery = fastest1f.fastRecovery;
                best1fRecovery15min = fastest1f.recovery15min;
                best1fRecoveryColor = fastest1f.fastRecoveryColor;
                best1fRecovery15Color = fastest1f.recovery15Color;
                best1fCorresponding5f = fastest1f.corresponding5f;
                best1fMaxSpeed = fastest1f.maxSpeed;
            }
            
            if (times5f.length > 0) {
                const fastest5f = times5f.reduce((min, current) => 
                    current.seconds < min.seconds ? current : min
                );
                best5f = fastest5f.time;
                dateOfBest5f = fastest5f.date;
                fastRecovery = fastest5f.fastRecovery;
                recovery15min = fastest5f.recovery15min;
                fastRecoveryColor = fastest5f.fastRecoveryColor;
                recovery15Color = fastest5f.recovery15Color;
                best5fMaxSpeed = fastest5f.maxSpeed;
                best5fCorresponding1f = fastest5f.corresponding1f;
            }
            
            if (speeds.length > 0) {
                maxSpeed = Math.max(...speeds);
            }
            
            if (maxSpeeds.length > 0) {
                const fastestMaxSpeed = maxSpeeds.reduce((max, current) => 
                    current.speed > max.speed ? current : max
                );
                dateOfMaxSpeed = fastestMaxSpeed.date;
                maxSpeedRecovery = fastestMaxSpeed.fastRecovery;
                maxSpeedRecovery15min = fastestMaxSpeed.recovery15min;
                maxSpeedRecoveryColor = fastestMaxSpeed.fastRecoveryColor;
                maxSpeedRecovery15Color = fastestMaxSpeed.recovery15Color;
                maxSpeedCorresponding1f = fastestMaxSpeed.corresponding1f;
                maxSpeedCorresponding5f = fastestMaxSpeed.corresponding5f;
            }
            
            allHorseDetailData[horseName] = detailData;
            
            // Find most recent gallop and race dates, plus most recent valeur
            let lastGallop = null;
            let lastRace = null;
            let valeur = null;
            
            if (gallopDates.length > 0) {
                const mostRecentGallop = new Date(Math.max(...gallopDates));
                lastGallop = mostRecentGallop.toLocaleDateString();
            }
            
            if (raceDates.length > 0) {
                const mostRecentRace = new Date(Math.max(...raceDates));
                lastRace = mostRecentRace.toLocaleDateString();
            }
            
            // Find most recent Valeur from races
            if (raceValeurs.length > 0) {
                const mostRecentValeur = raceValeurs.reduce((latest, current) => {
                    return current.date > latest.date ? current : latest;
                });
                valeur = mostRecentValeur.valeur;
            }
            
            return {
                name: horseName,
                lastGallop: lastGallop,
                lastRace: lastRace,
                valeur: valeur,
                age: age,
                group: getHorseGroup(horseName),
                best1f: best1f,
                best5f: best5f,
                dateOfBest5f: dateOfBest5f,
                dateOfBest1f: dateOfBest1f,
                best1fRecovery: best1fRecovery,
                best1fRecovery15min: best1fRecovery15min,
                best1fRecoveryColor: best1fRecoveryColor,
                best1fRecovery15Color: best1fRecovery15Color,
                best1fCorresponding5f: best1fCorresponding5f,
                fastRecovery: fastRecovery,
                recovery15min: recovery15min,
                fastRecoveryColor: fastRecoveryColor,
                recovery15Color: recovery15Color,
                maxSpeed: maxSpeed,
                best1fMaxSpeed: best1fMaxSpeed,
                best5fMaxSpeed: best5fMaxSpeed,
                best5fCorresponding1f: best5fCorresponding1f,
                dateOfMaxSpeed: dateOfMaxSpeed,
                maxSpeedRecovery: maxSpeedRecovery,
                maxSpeedRecovery15min: maxSpeedRecovery15min,
                maxSpeedRecoveryColor: maxSpeedRecoveryColor,
                maxSpeedRecovery15Color: maxSpeedRecovery15Color,
                maxSpeedCorresponding1f: maxSpeedCorresponding1f,
                maxSpeedCorresponding5f: maxSpeedCorresponding5f
            };
        }

        function isValidTime(timeStr) {
            if (!timeStr) return false;
            const str = timeStr.toString().trim();
            if (str === 'N/A' || str === '' || str === 'NaN') return false;
            return /^\d{2}:\d{2}\.\d{2}$/.test(str);
        }

        function timeToSeconds(timeStr) {
            const parts = timeStr.toString().trim().split(':');
            const minutes = parseInt(parts[0]);
            const secondsParts = parts[1].split('.');
            const seconds = parseInt(secondsParts[0]);
            const hundredths = parseInt(secondsParts[1]);
            
            return minutes * 60 + seconds + hundredths / 100;
        }

        function parseTimeToSeconds(timeStr) {
            if (!timeStr || timeStr === 'N/C' || timeStr === '-' || timeStr === 'N/A') return null;
            
            const str = timeStr.toString().trim();
            
            // Handle MM:SS.HH format (e.g., "01:23.45")
            if (/^\d{2}:\d{2}\.\d{2}$/.test(str)) {
                return timeToSeconds(str);
            }
            
            // Handle SS.HH format (e.g., "15.23" for seconds)
            if (/^\d{1,2}\.\d{2}$/.test(str)) {
                const parts = str.split('.');
                return parseInt(parts[0]) + parseInt(parts[1]) / 100;
            }
            
            // Handle plain seconds (e.g., "15")
            if (/^\d{1,2}$/.test(str)) {
                return parseInt(str);
            }
            
            return null;
        }

        function parseRecoveryValues(recoveryStr) {
            if (!recoveryStr || recoveryStr === 'N/C' || recoveryStr === '-' || recoveryStr === 'N/A') {
                return { fastRecovery: null, recovery15min: null };
            }
            
            const str = recoveryStr.toString().trim();
            
            // Handle "150/120" format (fast recovery / 15-min recovery)
            if (str.includes('/')) {
                const parts = str.split('/');
                const fastRecovery = parseInt(parts[0]);
                const recovery15min = parseInt(parts[1]);
                return {
                    fastRecovery: isNaN(fastRecovery) ? null : fastRecovery,
                    recovery15min: isNaN(recovery15min) ? null : recovery15min
                };
            }
            
            // Handle single number - assume it's fast recovery if no other context
            const singleValue = parseInt(str);
            if (!isNaN(singleValue)) {
                return {
                    fastRecovery: singleValue,
                    recovery15min: null
                };
            }
            
            return { fastRecovery: null, recovery15min: null };
        }

        function processWorstRecoveriesData(viewType) {
            const worstRecoveries = [];
            
            if (!currentWorkbook) {
                console.error('No workbook data available');
                return worstRecoveries;
            }
            
            filteredData.forEach(horse => {
                let worstSession = null;
                let worstValue = -1;
                
                // Get all training data for this horse
                const worksheet = currentWorkbook.Sheets[horse.name];
                if (!worksheet) {
                    return;
                }
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                
                for (let i = 1; i <= range.e.r; i++) {
                    const rowData = {};
                    for (let j = 0; j <= range.e.c; j++) {
                        const cell = worksheet[XLSX.utils.encode_cell({r: i, c: j})];
                        if (cell) {
                            const headerCell = worksheet[XLSX.utils.encode_cell({r: 0, c: j})];
                            if (headerCell && headerCell.v) {
                                const header = headerCell.v.toString().toLowerCase();
                                rowData[header] = cell.v;
                            }
                        }
                    }
                    
                    // Skip if no meaningful data
                    if (!rowData['date'] && !rowData['r√©cup√©ration apr√®s l\'effort'] && !rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration']) {
                        continue;
                    }
                    
                    // Parse recovery values
                    const fastRecoveryStr = rowData['r√©cup√©ration apr√®s l\'effort'] || rowData['fast recovery'] || '';
                    const recovery15minStr = rowData['fr√©quence cardiaque apr√®s 15 minutes de r√©cup√©ration'] || rowData['15 recovery'] || '';
                    
                    
                    const fastRecoveryParsed = parseRecoveryValues(fastRecoveryStr);
                    const recovery15minParsed = parseRecoveryValues(recovery15minStr);
                    
                    // Check which recovery value to compare based on view type
                    let currentValue = -1;
                    if (viewType === 'worstFastRecovery') {
                        if (fastRecoveryParsed.fastRecovery !== null) {
                            currentValue = fastRecoveryParsed.fastRecovery;
                        }
                    } else if (viewType === 'worst15minRecovery') {
                        if (recovery15minParsed.recovery15min !== null || recovery15minParsed.fastRecovery !== null) {
                            // For 15-min recovery, check both fields (some might be in recovery15min, others in fastRecovery)
                            const recovery15Value = parseFloat(recovery15minStr) || parseFloat(fastRecoveryStr) || -1;
                            if (!isNaN(recovery15Value)) {
                                currentValue = recovery15Value;
                            }
                        }
                    }
                    
                    
                    // Handle ties by preferring most recent date
                    const sessionDate = rowData['date'] instanceof Date ? rowData['date'] : new Date(rowData['date']);
                    const shouldUpdate = currentValue > worstValue || 
                                       (currentValue === worstValue && worstSession && sessionDate > new Date(worstSession.rawDate));
                    
                    if (shouldUpdate) {
                        worstValue = currentValue;
                        worstSession = {
                            horseName: horse.name,
                            // Add essential horse information from main horse data
                            age: horse.age,
                            group: horse.group,
                            lastGallop: horse.lastGallop,
                            lastRace: horse.lastRace,
                            valeur: horse.valeur,
                            date: rowData['date'] ? (rowData['date'] instanceof Date ? rowData['date'].toLocaleDateString() : rowData['date']) : '-',
                            rawDate: rowData['date'], // Keep raw date for comparison
                            distance: rowData['distance du travail'] || rowData['distance'] || '-',
                            maxSpeed: rowData['vitesse maximale'] || rowData['max speed'] || '-',
                            best1f: rowData['meilleurs 200m'] || rowData['best 200m'] || rowData['best 1f'] || '-',
                            best5f: rowData['meilleurs 1000m'] || rowData['best 1000m'] || rowData['best 5f'] || '-',
                            maxHeartRate: rowData['fr√©quence cardiaque maximale atteinte durant l\'entra√Ænement'] || rowData['max heart rate'] || '-',
                            // Store both recovery values from the same session
                            fastRecoveryValue: fastRecoveryParsed.fastRecovery || parseFloat(fastRecoveryStr) || null,
                            recovery15minValue: recovery15minParsed.recovery15min || recovery15minParsed.fastRecovery || parseFloat(recovery15minStr) || null,
                            fastRecoveryStr: fastRecoveryStr || '-',
                            recovery15minStr: recovery15minStr || '-',
                            recoveryValue: currentValue,
                            recoveryType: viewType === 'worstFastRecovery' ? 'Fast Recovery' : '15 Min Recovery'
                        };
                    }
                }
                
                if (worstSession) {
                    worstRecoveries.push(worstSession);
                }
            });
            
            return worstRecoveries;
        }

        function changeView() {
            const viewFilter = document.getElementById('viewFilter');
            const selectedView = viewFilter.value;
            
            // Update table headers based on selected view
            updateTableHeaders(selectedView);
            
            // Update data display
            displayData();
        }

        function updateTableHeaders(viewType) {
            const thead = document.querySelector('#horseTable thead tr');
            
            // Set headers and sort keys based on view type
            let dateColumnHeader, oneF_Header, fiveF_Header, dateSortKey, fastRecoverySortKey, recovery15SortKey;
            
            if (viewType === 'best1f') {
                dateColumnHeader = 'Date of Best 1F';
                oneF_Header = 'Best 1F';
                fiveF_Header = '5F Time';
                dateSortKey = 'dateOfBest1f';
                fastRecoverySortKey = 'best1fRecovery';
                recovery15SortKey = 'best1fRecovery15min';
            } else if (viewType === 'maxSpeed') {
                dateColumnHeader = 'Date of Max';
                oneF_Header = 'Time 1F';
                fiveF_Header = 'Time 5F';
                dateSortKey = 'dateOfMaxSpeed';
                fastRecoverySortKey = 'maxSpeedRecovery';
                recovery15SortKey = 'maxSpeedRecovery15min';
            } else if (viewType === 'worstFastRecovery' || viewType === 'worst15minRecovery') {
                dateColumnHeader = 'Date of Training';
                oneF_Header = '1F Time';
                fiveF_Header = '5F Time';
                dateSortKey = 'dateOfBest5f'; // For recovery views, use session date
                fastRecoverySortKey = 'fastRecovery';
                recovery15SortKey = 'recovery15min';
            } else { // best5f view
                dateColumnHeader = 'Date of Best 5F';
                oneF_Header = 'Time 1F';
                fiveF_Header = 'Best 5F';
                dateSortKey = 'dateOfBest5f';
                fastRecoverySortKey = 'fastRecovery';
                recovery15SortKey = 'recovery15min';
            }
            
            thead.innerHTML = `
                <th onclick="sortTable('name')" class="horse-name-col">Horse <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('age')">Age <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('group')">Group <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('lastGallop')" class="date-col">Last Gallop <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('lastRace')" class="date-col">Last Race <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('valeur')" class="date-col">Valeur <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('${dateSortKey}')" class="date-col">${dateColumnHeader} <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('${viewType === 'best1f' ? 'best1f' : viewType === 'maxSpeed' ? 'maxSpeedCorresponding1f' : viewType === 'best5f' ? 'best5fCorresponding1f' : 'best1f'}')">${oneF_Header} <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('${viewType === 'best1f' ? 'best1fCorresponding5f' : viewType === 'maxSpeed' ? 'maxSpeedCorresponding5f' : 'best5f'}')">${fiveF_Header} <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('${fastRecoverySortKey}')" class="fast-recovery-col">Fast Recovery <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('${recovery15SortKey}')">15 min <span class="sort-indicator">‚Üï</span></th>
                <th onclick="sortTable('maxSpeed')" class="max-speed-col">Max Speed <span class="sort-indicator">‚Üï</span></th>
            `;
        }

        function updateHorseFilter() {
            const horseList = document.getElementById('horseList');
            const horses = horseData.map(horse => horse.name).sort();
            
            horseList.innerHTML = '';
            horses.forEach(horseName => {
                const option = document.createElement('option');
                option.value = horseName;
                horseList.appendChild(option);
            });
        }

        function updateAgeFilter() {
            const ageFilter = document.getElementById('ageFilter');
            const ages = [...new Set(horseData.map(horse => horse.age).filter(age => age !== null))].sort((a, b) => a - b);
            
            ageFilter.innerHTML = '<option value="">All Ages</option>';
            ages.forEach(age => {
                const option = document.createElement('option');
                option.value = age;
                option.textContent = age;
                ageFilter.appendChild(option);
            });
        }

        function filterData() {
            const horseFilter = document.getElementById('horseFilter').value.toLowerCase().trim();
            const ageFilter = document.getElementById('ageFilter').value;
            
            filteredData = horseData.filter(horse => {
                if (horseFilter && !horse.name.toLowerCase().includes(horseFilter)) {
                    return false;
                }
                if (ageFilter && horse.age !== parseInt(ageFilter)) {
                    return false;
                }
                return true;
            });
            
            sortData();
        }


        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'asc';
            }
            
            sortData();
        }

        function sortData() {
            const viewFilter = document.getElementById('viewFilter');
            const selectedView = viewFilter.value;
            
            if (selectedView === 'best5f') {
                // Sort the original filtered data for Best 5F Time view
                filteredData.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];
                    
                    if (currentSort.column === 'best1f' || currentSort.column === 'best5f' || currentSort.column === 'best5fCorresponding1f') {
                        aVal = aVal ? timeToSeconds(aVal) : Infinity;
                        bVal = bVal ? timeToSeconds(bVal) : Infinity;
                    } else if (currentSort.column === 'age' || currentSort.column === 'maxSpeed' || currentSort.column === 'fastRecovery' || currentSort.column === 'recovery15min') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'lastGallop' || currentSort.column === 'lastRace' || currentSort.column === 'dateOfBest5f') {
                        aVal = aVal ? new Date(aVal) : new Date(0);
                        bVal = bVal ? new Date(bVal) : new Date(0);
                    } else if (currentSort.column === 'valeur') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'group') {
                        // Custom sorting for group: A < B < C, with '-' last
                        const getGroupSortValue = (group) => {
                            if (group === '-') return 999;
                            if (group === 'A') return 1;
                            if (group === 'B') return 2;
                            if (group === 'C') return 3;
                            if (group.includes('/')) {
                                // For combined groups like A/B, use the first letter
                                return getGroupSortValue(group.charAt(0));
                            }
                            return 500;
                        };
                        aVal = getGroupSortValue(aVal);
                        bVal = getGroupSortValue(bVal);
                    } else {
                        aVal = aVal || '';
                        bVal = bVal || '';
                    }
                    
                    if (currentSort.order === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            } else if (selectedView === 'best1f') {
                // Sort the original filtered data for Best 1F Time view
                filteredData.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];
                    
                    if (currentSort.column === 'best1f' || currentSort.column === 'best1fCorresponding5f') {
                        aVal = aVal ? timeToSeconds(aVal) : Infinity;
                        bVal = bVal ? timeToSeconds(bVal) : Infinity;
                    } else if (currentSort.column === 'age' || currentSort.column === 'maxSpeed' || currentSort.column === 'best1fRecovery' || currentSort.column === 'best1fRecovery15min') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'lastGallop' || currentSort.column === 'lastRace' || currentSort.column === 'dateOfBest1f') {
                        aVal = aVal ? new Date(aVal) : new Date(0);
                        bVal = bVal ? new Date(bVal) : new Date(0);
                    } else if (currentSort.column === 'valeur') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'group') {
                        // Custom sorting for group: A < B < C, with '-' last
                        const getGroupSortValue = (group) => {
                            if (group === '-') return 999;
                            if (group === 'A') return 1;
                            if (group === 'B') return 2;
                            if (group === 'C') return 3;
                            if (group.includes('/')) {
                                // For combined groups like A/B, use the first letter
                                return getGroupSortValue(group.charAt(0));
                            }
                            return 500;
                        };
                        aVal = getGroupSortValue(aVal);
                        bVal = getGroupSortValue(bVal);
                    } else {
                        aVal = aVal || '';
                        bVal = bVal || '';
                    }
                    
                    if (currentSort.order === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            } else if (selectedView === 'maxSpeed') {
                // Sort the original filtered data for Max Speed view
                filteredData.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];
                    
                    if (currentSort.column === 'maxSpeedCorresponding1f' || currentSort.column === 'maxSpeedCorresponding5f') {
                        aVal = aVal ? timeToSeconds(aVal) : Infinity;
                        bVal = bVal ? timeToSeconds(bVal) : Infinity;
                    } else if (currentSort.column === 'age' || currentSort.column === 'maxSpeed' || currentSort.column === 'maxSpeedRecovery' || currentSort.column === 'maxSpeedRecovery15min') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'lastGallop' || currentSort.column === 'lastRace' || currentSort.column === 'dateOfMaxSpeed') {
                        aVal = aVal ? new Date(aVal) : new Date(0);
                        bVal = bVal ? new Date(bVal) : new Date(0);
                    } else if (currentSort.column === 'valeur') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'group') {
                        // Custom sorting for group: A < B < C, with '-' last
                        const getGroupSortValue = (group) => {
                            if (group === '-') return 999;
                            if (group === 'A') return 1;
                            if (group === 'B') return 2;
                            if (group === 'C') return 3;
                            if (group.includes('/')) {
                                // For combined groups like A/B, use the first letter
                                return getGroupSortValue(group.charAt(0));
                            }
                            return 500;
                        };
                        aVal = getGroupSortValue(aVal);
                        bVal = getGroupSortValue(bVal);
                    } else {
                        aVal = aVal || '';
                        bVal = bVal || '';
                    }
                    
                    if (currentSort.order === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            } else {
                // For recovery views, we need to sort differently since displayData() 
                // will process the recovery data. The sorting will be handled in displayData()
                // by sorting the recovery session data
            }
            
            displayData();
        }

        function displayData() {
            const tbody = document.getElementById('horseTableBody');
            const viewFilter = document.getElementById('viewFilter');
            const selectedView = viewFilter.value;
            
            let dataToDisplay = [];
            
            if (selectedView === 'best5f') {
                // Use existing filteredData for Best 5F Time view
                dataToDisplay = filteredData;
                
                if (dataToDisplay.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="no-data">No horses match the current filters.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = dataToDisplay.map(horse => {
                    const fastRecoveryStyle = horse.fastRecoveryColor ? `style="background-color: ${horse.fastRecoveryColor}; color: #000;"` : '';
                    const recovery15Style = horse.recovery15Color ? `style="background-color: ${horse.recovery15Color}; color: #000;"` : '';
                    
                    return `
                        <tr class="clickable-row" onclick="showHorseDetail('${horse.name}')">
                            <td class="horse-name-cell"><span style="${getHorseNameColor(horse.name)} font-weight: bold; padding: 2px 6px; border-radius: 3px;">${horse.name}</span></td>
                            <td class="age-cell">${cleanNCValue(horse.age)}</td>
                            <td class="group-cell" style="text-align: center; font-weight: bold;">${horse.group}</td>
                            <td class="date-col">${cleanNCValue(horse.lastGallop)}</td>
                            <td class="date-col">${cleanNCValue(horse.lastRace)}</td>
                            <td class="date-col">${cleanNCValue(horse.valeur)}</td>
                            <td class="date-col">${cleanNCValue(horse.dateOfBest5f)}</td>
                            <td class="time-cell">${cleanNCValue(horse.best5fCorresponding1f)}</td>
                            <td class="time-cell">${cleanNCValue(horse.best5f)}</td>
                            <td class="recovery-cell fast-recovery-col" ${fastRecoveryStyle}>${cleanNCValue(horse.fastRecovery)}</td>
                            <td class="recovery15-cell" ${recovery15Style}>${cleanNCValue(horse.recovery15min)}</td>
                            <td class="speed-cell max-speed-col">${horse.best5fMaxSpeed && horse.best5fMaxSpeed !== 'N/C' && horse.best5fMaxSpeed !== 'n/c' ? horse.best5fMaxSpeed.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else if (selectedView === 'best1f') {
                // Use existing filteredData but display Best 1F Time data
                dataToDisplay = filteredData;
                
                if (dataToDisplay.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="no-data">No horses match the current filters.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = dataToDisplay.map(horse => {
                    const fastRecoveryStyle = horse.best1fRecoveryColor ? `style="background-color: ${horse.best1fRecoveryColor}; color: #000;"` : '';
                    const recovery15Style = horse.best1fRecovery15Color ? `style="background-color: ${horse.best1fRecovery15Color}; color: #000;"` : '';
                    
                    return `
                        <tr class="clickable-row" onclick="showHorseDetail('${horse.name}')">
                            <td class="horse-name-cell"><span style="${getHorseNameColor(horse.name)} font-weight: bold; padding: 2px 6px; border-radius: 3px;">${horse.name}</span></td>
                            <td class="age-cell">${cleanNCValue(horse.age)}</td>
                            <td class="group-cell" style="text-align: center; font-weight: bold;">${horse.group}</td>
                            <td class="date-col">${cleanNCValue(horse.lastGallop)}</td>
                            <td class="date-col">${cleanNCValue(horse.lastRace)}</td>
                            <td class="date-col">${cleanNCValue(horse.valeur)}</td>
                            <td class="date-col">${cleanNCValue(horse.dateOfBest1f)}</td>
                            <td class="time-cell">${cleanNCValue(horse.best1f)}</td>
                            <td class="time-cell">${cleanNCValue(horse.best1fCorresponding5f)}</td>
                            <td class="recovery-cell fast-recovery-col" ${fastRecoveryStyle}>${cleanNCValue(horse.best1fRecovery)}</td>
                            <td class="recovery15-cell" ${recovery15Style}>${cleanNCValue(horse.best1fRecovery15min)}</td>
                            <td class="speed-cell max-speed-col">${horse.best1fMaxSpeed && horse.best1fMaxSpeed !== 'N/C' && horse.best1fMaxSpeed !== 'n/c' ? horse.best1fMaxSpeed.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else if (selectedView === 'maxSpeed') {
                // Use existing filteredData but display Max Speed data
                dataToDisplay = filteredData;
                
                if (dataToDisplay.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="no-data">No horses match the current filters.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = dataToDisplay.map(horse => {
                    const fastRecoveryStyle = horse.maxSpeedRecoveryColor ? `style="background-color: ${horse.maxSpeedRecoveryColor}; color: #000;"` : '';
                    const recovery15Style = horse.maxSpeedRecovery15Color ? `style="background-color: ${horse.maxSpeedRecovery15Color}; color: #000;"` : '';
                    
                    return `
                        <tr class="clickable-row" onclick="showHorseDetail('${horse.name}')">
                            <td class="horse-name-cell"><span style="${getHorseNameColor(horse.name)} font-weight: bold; padding: 2px 6px; border-radius: 3px;">${horse.name}</span></td>
                            <td class="age-cell">${cleanNCValue(horse.age)}</td>
                            <td class="group-cell" style="text-align: center; font-weight: bold;">${horse.group}</td>
                            <td class="date-col">${cleanNCValue(horse.lastGallop)}</td>
                            <td class="date-col">${cleanNCValue(horse.lastRace)}</td>
                            <td class="date-col">${cleanNCValue(horse.valeur)}</td>
                            <td class="date-col">${cleanNCValue(horse.dateOfMaxSpeed)}</td>
                            <td class="time-cell">${cleanNCValue(horse.maxSpeedCorresponding1f)}</td>
                            <td class="time-cell">${cleanNCValue(horse.maxSpeedCorresponding5f)}</td>
                            <td class="recovery-cell fast-recovery-col" ${fastRecoveryStyle}>${cleanNCValue(horse.maxSpeedRecovery)}</td>
                            <td class="recovery15-cell" ${recovery15Style}>${cleanNCValue(horse.maxSpeedRecovery15min)}</td>
                            <td class="speed-cell max-speed-col">${horse.maxSpeed && horse.maxSpeed !== 'N/C' && horse.maxSpeed !== 'n/c' ? horse.maxSpeed.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                // Process worst recoveries data for the recovery views
                dataToDisplay = processWorstRecoveriesData(selectedView);
                
                if (dataToDisplay.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" class="no-data">No recovery data available.</td></tr>';
                    return;
                }
                
                // Sort the recovery data based on current sort settings
                dataToDisplay.sort((a, b) => {
                    let aVal, bVal;
                    
                    // Map the sort column to the recovery data structure
                    if (currentSort.column === 'name') {
                        aVal = a.horseName;
                        bVal = b.horseName;
                    } else if (currentSort.column === 'group') {
                        aVal = a.group || '-';
                        bVal = b.group || '-';
                        // Apply the same group sorting logic
                        const getGroupSortValue = (group) => {
                            if (group === '-') return 999;
                            if (group === 'A') return 1;
                            if (group === 'B') return 2;
                            if (group === 'C') return 3;
                            if (group.includes('/')) {
                                return getGroupSortValue(group.charAt(0));
                            }
                            return 500;
                        };
                        aVal = getGroupSortValue(aVal);
                        bVal = getGroupSortValue(bVal);
                    } else if (currentSort.column === 'lastGallop' || currentSort.column === 'lastRace' || currentSort.column === 'valeur' || currentSort.column === 'age') {
                        // These values are now directly available in the recovery session objects
                        aVal = a[currentSort.column] || '';
                        bVal = b[currentSort.column] || '';
                    } else if (currentSort.column === 'best1f') {
                        aVal = a.best1f;
                        bVal = b.best1f;
                    } else if (currentSort.column === 'best5f') {
                        aVal = a.best5f;
                        bVal = b.best5f;
                    } else if (currentSort.column === 'dateOfBest5f') {
                        aVal = a.date;
                        bVal = b.date;
                    } else if (currentSort.column === 'fastRecovery') {
                        aVal = a.fastRecoveryValue || 0;
                        bVal = b.fastRecoveryValue || 0;
                    } else if (currentSort.column === 'recovery15min') {
                        aVal = a.recovery15minValue || 0;
                        bVal = b.recovery15minValue || 0;
                    } else if (currentSort.column === 'maxSpeed') {
                        aVal = a.maxSpeed;
                        bVal = b.maxSpeed;
                    } else {
                        aVal = a[currentSort.column] || '';
                        bVal = b[currentSort.column] || '';
                    }
                    
                    // Parse values appropriately
                    if (currentSort.column === 'best1f' || currentSort.column === 'best5f') {
                        aVal = aVal ? timeToSeconds(aVal) : Infinity;
                        bVal = bVal ? timeToSeconds(bVal) : Infinity;
                    } else if (currentSort.column === 'age' || currentSort.column === 'maxSpeed' || currentSort.column === 'fastRecovery' || currentSort.column === 'recovery15min') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    } else if (currentSort.column === 'lastGallop' || currentSort.column === 'lastRace' || currentSort.column === 'dateOfBest5f') {
                        aVal = aVal ? new Date(aVal) : new Date(0);
                        bVal = bVal ? new Date(bVal) : new Date(0);
                    } else if (currentSort.column === 'valeur') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }
                    
                    if (currentSort.order === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
                
                tbody.innerHTML = dataToDisplay.map(session => {
                    // Use the same color coding functions as the original table
                    const fastRecoveryColor = getFastRecoveryColor(session.fastRecoveryValue);
                    const recovery15Color = getRecovery15Color(session.recovery15minValue);
                    
                    const fastRecoveryStyle = fastRecoveryColor ? `style="background-color: ${fastRecoveryColor}; color: #000;"` : '';
                    const recovery15Style = recovery15Color ? `style="background-color: ${recovery15Color}; color: #000;"` : '';
                    
                    // Show both recovery values from the same training session
                    const fastRecoveryDisplay = session.fastRecoveryValue ? session.fastRecoveryValue : '-';
                    const recovery15Display = session.recovery15minValue ? session.recovery15minValue : '-';
                    
                    return `
                        <tr class="clickable-row" onclick="showHorseDetail('${session.horseName}')">
                            <td class="horse-name-cell"><span style="${getHorseNameColor(session.horseName)} font-weight: bold; padding: 2px 6px; border-radius: 3px;">${session.horseName}</span></td>
                            <td class="age-cell">${cleanNCValue(session.age)}</td>
                            <td class="group-cell" style="text-align: center; font-weight: bold;">${session.group}</td>
                            <td class="date-col">${cleanNCValue(session.lastGallop)}</td>
                            <td class="date-col">${cleanNCValue(session.lastRace)}</td>
                            <td class="date-col">${cleanNCValue(session.valeur)}</td>
                            <td class="date-col">${cleanNCValue(session.date)}</td>
                            <td class="time-cell">${cleanNCValue(session.best1f)}</td>
                            <td class="time-cell">${cleanNCValue(session.best5f)}</td>
                            <td class="recovery-cell fast-recovery-col" ${fastRecoveryStyle}>${fastRecoveryDisplay}</td>
                            <td class="recovery15-cell" ${recovery15Style}>${recovery15Display}</td>
                            <td class="speed-cell max-speed-col">${cleanNCValue(session.maxSpeed)}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Helper function to format time values for Excel CSV export
        function formatTimeForExcel(value) {
            if (!value || value === '' || value === 'N/C') {
                return '';
            }
            // Check if value looks like a time format (contains colon or typical time patterns)
            if (typeof value === 'string' && (value.includes(':') || /^\d{2}:\d{2}/.test(value) || /^\d+\.\d+$/.test(value))) {
                return `="${value}"`; // Force Excel to treat as text
            }
            return value;
        }

        function exportToCsv() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Horse Name', 'Age', 'Group', 'Last Gallop', 'Last Race', 'Valeur', 'Date of Best 5F', 'Time 1F', 'Best 5F', 'Fast Recovery', '15 min Recovery', 'Max Speed'];
            let csvContent = headers.join(',') + '\n';

            filteredData.forEach(horse => {
                const row = [
                    `"${horse.name}"`,
                    horse.age || '',
                    horse.group || '',
                    horse.lastGallop || '',
                    horse.lastRace || '',
                    horse.valeur || '',
                    horse.dateOfBest5f || '',
                    formatTimeForExcel(horse.best1f),
                    formatTimeForExcel(horse.best5f),
                    formatTimeForExcel(horse.fastRecovery),
                    formatTimeForExcel(horse.recovery15min),
                    horse.maxSpeed ? horse.maxSpeed.toFixed(2) : ''
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'fastest_training_times.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function showHorseDetail(horseName) {
            document.getElementById('horseDetailTitle').textContent = `${horseName} - Training Details`;
            currentHorseDetailData = allHorseDetailData[horseName] || [];
            
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('horseDetailView').style.display = 'block';
            
            // Update back button text if not coming from gallops
            if (!navigationState.fromGallops) {
                updateBackButtonText();
            }
            
            // Reset scroll position to top and left
            window.scrollTo(0, 0);
            
            // Reset table scroll position to left
            const tableContainer = document.querySelector('.horse-detail-view .table-container');
            if (tableContainer) {
                tableContainer.scrollLeft = 0;
            }
            
            // Reset to default sort (date descending)
            currentHorseDetailSort = { column: 'date', order: 'desc' };
            document.getElementById('horseSortBy').value = 'date';
            document.getElementById('horseSortOrder').value = 'desc';
            
            // Reset age filter and workout filter
            document.getElementById('horseAgeFilter').value = '';
            document.getElementById('horseWorkoutFilter').value = 'all';
            
            // Populate age filter for this horse
            updateHorseAgeFilter(horseName);
            
            document.getElementById('horseSortBy').addEventListener('change', updateHorseDetailSort);
            document.getElementById('horseSortOrder').addEventListener('change', updateHorseDetailSort);
            document.getElementById('horseAgeFilter').addEventListener('change', updateHorseDetailSort);
            document.getElementById('horseWorkoutFilter').addEventListener('change', updateHorseDetailSort);
            document.getElementById('exportHorseCsv').addEventListener('click', exportHorseDataToCsv);
            
            sortHorseDetailData();
        }

        function showMainView() {
            document.getElementById('horseDetailView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            
            document.getElementById('horseFilter').value = '';
            filterData();
        }

        
        function updateHorseAgeFilter(horseName) {
            const ageFilter = document.getElementById('horseAgeFilter');
            const horseData = allHorseDetailData[horseName] || [];
            const ages = [...new Set(horseData.map(row => row.age).filter(age => age && age !== 'N/A'))].sort((a, b) => a - b);
            
            ageFilter.innerHTML = '<option value="">All Ages</option>';
            ages.forEach(age => {
                const option = document.createElement('option');
                option.value = age;
                option.textContent = age;
                ageFilter.appendChild(option);
            });
        }

        function updateHorseDetailSort() {
            const sortBy = document.getElementById('horseSortBy').value;
            const sortOrder = document.getElementById('horseSortOrder').value;
            
            currentHorseDetailSort = { column: sortBy, order: sortOrder };
            sortHorseDetailData();
        }

        function sortHorseTable(column) {
            if (currentHorseDetailSort.column === column) {
                currentHorseDetailSort.order = currentHorseDetailSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentHorseDetailSort.column = column;
                currentHorseDetailSort.order = 'asc';
            }
            
            document.getElementById('horseSortBy').value = column;
            document.getElementById('horseSortOrder').value = currentHorseDetailSort.order;
            
            sortHorseDetailData();
        }

        function sortHorseDetailData() {
            let horseName = document.getElementById('horseDetailTitle').textContent.replace(' - Training Details', '');
            let dataToSort = allHorseDetailData[horseName] || [];
            
            // Apply age filter
            const ageFilter = document.getElementById('horseAgeFilter').value;
            if (ageFilter) {
                dataToSort = dataToSort.filter(row => row.age === ageFilter);
            }
            
            // Apply workout/race filter
            const workoutFilter = document.getElementById('horseWorkoutFilter').value;
            if (workoutFilter !== 'all') {
                dataToSort = dataToSort.filter(row => {
                    switch (workoutFilter) {
                        case 'gallops':
                            return row.isBoldRed && !row.isRaceResult;
                        case 'races':
                            return row.isRaceResult;
                        case 'gallops-races':
                            return row.isBoldRed || row.isRaceResult;
                        default:
                            return true;
                    }
                });
            }
            
            currentHorseDetailData = [...dataToSort];
            
            currentHorseDetailData.sort((a, b) => {
                let aVal = a[currentHorseDetailSort.column];
                let bVal = b[currentHorseDetailSort.column];
                
                if (currentHorseDetailSort.column === 'best200m' || currentHorseDetailSort.column === 'best800m' || currentHorseDetailSort.column === 'best1000m') {
                    aVal = aVal && isValidTime(aVal) ? timeToSeconds(aVal) : Infinity;
                    bVal = bVal && isValidTime(bVal) ? timeToSeconds(bVal) : Infinity;
                } else if (currentHorseDetailSort.column === 'age' || currentHorseDetailSort.column === 'maxSpeed' || currentHorseDetailSort.column === 'avgSpeed' || currentHorseDetailSort.column === 'maxHeartRate' || currentHorseDetailSort.column === 'recovery' || currentHorseDetailSort.column === 'recovery15min' || currentHorseDetailSort.column === 'distance' || currentHorseDetailSort.column === 'heartRateReturn' || currentHorseDetailSort.column === 'amplitude35') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (currentHorseDetailSort.column === 'date') {
                    aVal = aVal ? new Date(aVal) : new Date(0);
                    bVal = bVal ? new Date(bVal) : new Date(0);
                } else {
                    aVal = aVal || '';
                    bVal = bVal || '';
                }
                
                if (currentHorseDetailSort.order === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            displayHorseDetailData();
        }

        function displayHorseDetailData() {
            const tbody = document.getElementById('horseDetailTableBody');
            
            if (currentHorseDetailData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" class="no-data">No training data available for this horse.</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentHorseDetailData.map((row, index) => {
                const fastRecoveryColor = getFastRecoveryColor(row.recovery);
                const recovery15Color = getRecovery15Color(row.recovery15min);
                const best1000mColor = get1000mTimeColor(row.best1000m);
                
                const fastRecoveryStyle = fastRecoveryColor ? `style="background-color: ${fastRecoveryColor}; color: #000;"` : '';
                const recovery15Style = recovery15Color ? `style="background-color: ${recovery15Color}; color: #000;"` : '';
                const best1000mStyle = best1000mColor ? `style="background-color: ${best1000mColor}; color: #000;"` : '';
                
                let rowClass = '';
                let dateContent = row.date || '-';
                let horseContent = `<strong>${row.cheval || '-'}</strong>`;
                
                if (row.isRaceResult) {
                    rowClass = 'race-row';
                    
                    // Use extracted hyperlinks from Excel if available, otherwise generate them
                    if (row.dateHyperlink) {
                        dateContent = `<a href="${row.dateHyperlink}" target="_blank" style="color: inherit; text-decoration: none;">${row.date}</a>`;
                    }
                    
                    if (row.horseHyperlink) {
                        horseContent = `<a href="${row.horseHyperlink}" target="_blank" style="color: inherit; text-decoration: none; font-weight: bold;">${row.cheval || '-'}</a>`;
                    } else {
                        // Fallback: Generate tracking report URL if no hyperlink found
                        const track = extractTrackFromRecoveryText(row.recovery);
                        const raceNumber = extractRaceNumberFromText(row.recovery);
                        
                        if (track && row.date) {
                            const trackingUrl = generateTrackingReportUrl(row.date, track, raceNumber);
                            if (trackingUrl) {
                                horseContent = `<a href="${trackingUrl}" target="_blank" style="color: inherit; text-decoration: none; font-weight: bold;">${row.cheval || '-'}</a>`;
                            }
                        }
                    }
                } else if (row.isBoldRed) {
                    rowClass = 'workout-row';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td>${dateContent}</td>
                        <td class="horse-name-cell">${horseContent}</td>
                        <td class="age-cell">${cleanNCValue(row.age)}</td>
                        <td>${cleanNCValue(row.distance)}</td>
                        <td class="speed-cell">${cleanNCValue(row.maxSpeed)}</td>
                        <td style="color: #000;">${cleanNCValue(row.avgSpeed)}</td>
                        <td class="time-cell">${cleanNCValue(row.best200m)}</td>
                        <td class="time-cell">${cleanNCValue(row.best800m)}</td>
                        <td class="time-cell" ${best1000mStyle}>${cleanNCValue(row.best1000m)}</td>
                        <td>${cleanNCValue(row.maxHeartRate)}</td>
                        <td class="recovery-cell" ${fastRecoveryStyle}><div class="cell-content">${cleanNCValue(row.recovery)}</div></td>
                        <td class="recovery15-cell" ${recovery15Style}>${cleanNCValue(row.recovery15min)}</td>
                        <td>${cleanNCValue(row.heartRateReturn)}</td>
                        <td>${cleanNCValue(row.amplitude35)}</td>
                        <td>${cleanNCValue(row.effort1)}</td>
                        <td>${cleanNCValue(row.effort2)}</td>
                        <td>${cleanNCValue(row.effort3)}</td>
                        <td>${cleanNCValue(row.effort4)}</td>
                        <td>${cleanNCValue(row.effort5)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function exportHorseDataToCsv() {
            if (currentHorseDetailData.length === 0) {
                alert('No data to export');
                return;
            }

            const horseName = document.getElementById('horseDetailTitle').textContent.replace(' - Training Details', '');
            
            // Create CSV header with all columns
            const headers = [
                'Date', 'Cheval', '√Çge', 'Distance du travail', 'Vitesse maximale', 'Vitesse moyenne du travail',
                'Meilleurs 200m', 'Meilleurs 800m', 'Meilleurs 1000m', 'Fr√©quence cardiaque maximale',
                'R√©cup√©ration apr√®s l\'effort', '15 min r√©cup√©ration', 'Fr√©quence cardiaque au retour',
                'Amplitude √† 35 km/h', 'Temps zone effort 1', 'Temps zone effort 2', 'Temps zone effort 3',
                'Temps zone effort 4', 'Temps zone effort 5'
            ];
            let csvContent = headers.join(',') + '\n';

            // Add data rows
            currentHorseDetailData.forEach(row => {
                const csvRow = [
                    `"${row.date || ''}"`,
                    `"${row.cheval || ''}"`,
                    row.age || '',
                    row.distance || '',
                    row.maxSpeed || '',
                    row.avgSpeed || '',
                    formatTimeForExcel(row.best200m),
                    formatTimeForExcel(row.best800m),
                    formatTimeForExcel(row.best1000m),
                    row.maxHeartRate || '',
                    formatTimeForExcel(row.recovery),
                    formatTimeForExcel(row.recovery15min),
                    row.heartRateReturn || '',
                    row.amplitude35 || '',
                    formatTimeForExcel(row.effort1),
                    formatTimeForExcel(row.effort2),
                    formatTimeForExcel(row.effort3),
                    formatTimeForExcel(row.effort4),
                    formatTimeForExcel(row.effort5)
                ];
                csvContent += csvRow.join(',') + '\n';
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${horseName}_training_data.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Calendar functionality
        let currentCalendarDate = new Date();
        let currentHorseForCalendar = '';

        const frenchMonths = [
            'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
        ];

        const frenchDays = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

        function showCalendarPopup() {
            // Get current horse name from the detail title
            const title = document.getElementById('horseDetailTitle').textContent;
            currentHorseForCalendar = title.replace(' - Training Details', '');
            
            // Set calendar title
            document.getElementById('calendarTitle').textContent = `Calendrier d'Entra√Ænement - ${currentHorseForCalendar}`;
            
            // Show overlay
            const overlay = document.getElementById('calendarOverlay');
            overlay.style.display = 'flex';
            
            // Generate calendar for current month
            generateCalendar();
        }

        function hideCalendarPopup() {
            document.getElementById('calendarOverlay').style.display = 'none';
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            generateCalendar();
        }

        function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month/year display
            document.getElementById('currentMonthYear').textContent = 
                `${frenchMonths[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get starting day of week (0=Sunday, 1=Monday, etc.)
            // Convert to European format (0=Monday, 6=Sunday)
            let startingDayOfWeek = firstDay.getDay();
            startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add day headers
            frenchDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Add empty cells for days before the month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Add training events for this day
                addTrainingEvents(dayCell, year, month, day);
                
                calendarGrid.appendChild(dayCell);
            }
        }

        function addTrainingEvents(dayCell, year, month, day) {
            if (!currentHorseForCalendar || !currentHorseDetailData) return;
            
            const targetDate = new Date(year, month, day);
            const targetDateStr = targetDate.toLocaleDateString('fr-FR');
            
            // Find training data for this date
            const dayEvents = currentHorseDetailData.filter(row => {
                if (!row.date) return false;
                const rowDate = new Date(row.date);
                return rowDate.toLocaleDateString('fr-FR') === targetDateStr;
            });
            
            // Add has-events class if there are training events
            if (dayEvents.length > 0) {
                dayCell.classList.add('has-events');
            }
            
            dayEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'calendar-event';
                
                if (event.isRaceResult) {
                    eventDiv.classList.add('race');
                    // Show full race information with distance and race details
                    let raceInfo = '';
                    
                    // Add distance if available
                    if (event.distance) {
                        raceInfo += `${event.distance}m `;
                    }
                    
                    // Add race details from recovery field
                    if (event.recovery) {
                        const raceDetails = event.recovery.toString();
                        raceInfo += raceDetails;
                    } else {
                        raceInfo += 'Course';
                    }
                    
                    eventDiv.innerHTML = raceInfo;
                    eventDiv.style.whiteSpace = 'normal';
                    eventDiv.style.wordWrap = 'break-word';
                } else {
                    // Handle all other training days (non-race, non-gallop)
                    const best5f = event.best1000m || '';
                    const recoveryText = event.recovery || '';
                    
                    // Parse fast recovery and 15-min recovery
                    let fastRecovery = '';
                    let recovery15min = '';
                    
                    if (recoveryText.includes('/')) {
                        const parts = recoveryText.split('/');
                        fastRecovery = parts[0].trim();
                        recovery15min = parts[1] ? parts[1].trim() : '';
                    } else if (recoveryText && !isNaN(parseFloat(recoveryText))) {
                        fastRecovery = recoveryText.trim();
                    }
                    
                    // Get 15-min recovery from separate field if available
                    if (!recovery15min && event.recovery15min) {
                        recovery15min = event.recovery15min.toString();
                    }
                    
                    // Only create display if we have some data
                    if (best5f || fastRecovery || recovery15min) {
                        // Set up vertical layout for 5F time on top, recovery numbers below
                        eventDiv.style.display = 'flex';
                        eventDiv.style.flexDirection = 'column';
                        eventDiv.style.alignItems = 'center';
                        eventDiv.style.justifyContent = 'center';
                        eventDiv.style.gap = '1px';
                        // Add class for gallops and set background color
                        if (event.isBoldRed) {
                            eventDiv.classList.add('gallop');
                            // Keep the red background for gallops like before
                        } else {
                            // No fill for regular training days
                            eventDiv.style.backgroundColor = 'transparent';
                        }
                        
                        // Add 5F time on top with color coding
                        if (best5f) {
                            const timeDiv = document.createElement('div');
                            timeDiv.style.fontSize = '13px';
                            timeDiv.style.textAlign = 'center';
                            timeDiv.style.padding = '2px 4px';
                            timeDiv.style.borderRadius = '2px';
                            
                            // Apply color coding to 5F time
                            const timeColor = get1000mTimeColor(event.best1000m);
                            if (timeColor) {
                                timeDiv.style.backgroundColor = timeColor;
                                timeDiv.style.color = '#000';
                            }
                            timeDiv.textContent = best5f;
                            eventDiv.appendChild(timeDiv);
                        }
                        
                        // Add recovery values side-by-side under 5F time
                        if (fastRecovery || recovery15min) {
                            const recoveryContainer = document.createElement('div');
                            recoveryContainer.style.display = 'flex';
                            recoveryContainer.style.justifyContent = 'center';
                            recoveryContainer.style.gap = '4px';
                            recoveryContainer.style.fontSize = '12px';
                            recoveryContainer.style.fontWeight = 'bold';
                            
                            if (fastRecovery) {
                                const fastRecoveryColor = getFastRecoveryColor(fastRecovery);
                                const fastSpan = document.createElement('span');
                                fastSpan.textContent = fastRecovery;
                                fastSpan.style.padding = '2px 4px';
                                fastSpan.style.borderRadius = '2px';
                                fastSpan.style.textAlign = 'center';
                                if (fastRecoveryColor) {
                                    fastSpan.style.backgroundColor = fastRecoveryColor;
                                    fastSpan.style.color = '#000';
                                }
                                recoveryContainer.appendChild(fastSpan);
                            }
                            
                            if (recovery15min) {
                                const recovery15Color = getRecovery15Color(recovery15min);
                                const recovery15Span = document.createElement('span');
                                recovery15Span.textContent = recovery15min;
                                recovery15Span.style.padding = '2px 4px';
                                recovery15Span.style.borderRadius = '2px';
                                recovery15Span.style.textAlign = 'center';
                                if (recovery15Color) {
                                    recovery15Span.style.backgroundColor = recovery15Color;
                                    recovery15Span.style.color = '#000';
                                }
                                recoveryContainer.appendChild(recovery15Span);
                            }
                            
                            eventDiv.appendChild(recoveryContainer);
                        }
                    } else {
                        // If no training data, don't add anything to the calendar day
                        return;
                    }
                }
                
                dayCell.appendChild(eventDiv);
            });
        }

        // Close calendar when clicking outside
        document.getElementById('calendarOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCalendarPopup();
            }
        });

        // PDF Export function
        async function exportCalendarToPDF() {
            try {
                // Create a clean temporary container for PDF generation
                const tempContainer = document.createElement('div');
                tempContainer.style.background = 'white';
                tempContainer.style.padding = '40px';
                tempContainer.style.width = '900px';
                tempContainer.style.position = 'absolute';
                tempContainer.style.top = '-9999px';
                tempContainer.style.left = '-9999px';
                tempContainer.style.fontFamily = 'Arial, sans-serif';
                document.body.appendChild(tempContainer);
                
                // Create clean title for PDF (just horse name and month/year)
                const monthYear = document.getElementById('currentMonthYear').textContent;
                const titleDiv = document.createElement('div');
                titleDiv.style.textAlign = 'center';
                titleDiv.style.marginBottom = '30px';
                titleDiv.style.fontSize = '24px';
                titleDiv.style.fontWeight = 'bold';
                titleDiv.style.color = '#333';
                titleDiv.textContent = `Calendrier d'Entra√Ænement - ${currentHorseForCalendar} - ${monthYear}`;
                tempContainer.appendChild(titleDiv);
                
                // Clone only the calendar grid
                const calendarGrid = document.getElementById('calendarGrid');
                const gridClone = calendarGrid.cloneNode(true);
                gridClone.style.margin = '0 auto';
                gridClone.style.maxWidth = '800px';
                
                tempContainer.appendChild(gridClone);
                
                // Generate canvas from the temporary container
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                
                // Calculate dimensions to fit the page with proper margins
                const pageWidth = 297; // A4 landscape width
                const pageHeight = 210; // A4 landscape height
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                const maxHeight = pageHeight - (margin * 2);
                
                const imgWidth = Math.min(maxWidth, (canvas.width * maxHeight) / canvas.height);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Center the image on the page
                const x = (pageWidth - imgWidth) / 2;
                const y = (pageHeight - imgHeight) / 2;
                
                // Add image to PDF
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                
                // Generate filename with horse name and month/year
                const horseName = currentHorseForCalendar.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `Calendar_${horseName}_${monthYear.replace(/\s+/g, '_')}.pdf`;
                
                // Save the PDF
                pdf.save(filename);
                
                // Clean up
                document.body.removeChild(tempContainer);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
            }
        }

        // Gallops Comparison functionality
        let gallopsByDate = {};
        let currentGallopSort = { column: 'best5f', order: 'asc' };
        let navigationState = { fromGallops: false, gallopDate: null };


        function processGallopsByDate() {
            gallopsByDate = {};
            
            // Go through all horses and their detail data
            Object.keys(allHorseDetailData).forEach(horseName => {
                const horseDetailData = allHorseDetailData[horseName];
                if (!horseDetailData) return;
                
                horseDetailData.forEach(row => {
                    // Check if this is a gallop (using same logic as existing gallop detection)
                    if (row.isBoldRed && row.date) {
                        const dateStr = new Date(row.date).toLocaleDateString('en-US');
                        
                        if (!gallopsByDate[dateStr]) {
                            gallopsByDate[dateStr] = [];
                        }
                        
                        // Parse recovery values
                        let fastRecovery = '';
                        let recovery15min = '';
                        const recoveryText = row.recovery || '';
                        
                        if (recoveryText.includes('/')) {
                            const parts = recoveryText.split('/');
                            fastRecovery = parts[0].trim();
                            recovery15min = parts[1] ? parts[1].trim() : '';
                        } else if (recoveryText && !isNaN(parseFloat(recoveryText))) {
                            fastRecovery = recoveryText.trim();
                        }
                        
                        if (!recovery15min && row.recovery15min) {
                            recovery15min = row.recovery15min.toString();
                        }
                        
                        gallopsByDate[dateStr].push({
                            horse: horseName,
                            age: row.age || '',
                            distance: row.distance || '',
                            maxSpeed: row.maxSpeed || '',
                            avgSpeed: row.avgSpeed || '',
                            best200m: row.best200m || '',
                            best800m: row.best800m || '',
                            best5f: row.best1000m || '',
                            maxHeartRate: row.maxHeartRate || '',
                            fastRecovery: fastRecovery,
                            recovery15min: recovery15min,
                            heartRateReturn: row.heartRateReturn || '',
                            amplitude35: row.amplitude35 || '',
                            effort1: row.effort1 || '',
                            effort2: row.effort2 || '',
                            effort3: row.effort3 || '',
                            effort4: row.effort4 || '',
                            effort5: row.effort5 || '',
                            date: row.date
                        });
                    }
                });
            });
        }

        function showGallopsView() {
            // Process gallops data
            processGallopsByDate();
            
            // Hide main view and show gallops view
            document.getElementById('mainView').style.display = 'none';
            document.querySelector('.horse-detail-view').style.display = 'none';
            document.getElementById('gallopView').style.display = 'block';
            
            // Populate date filter
            populateGallopDateFilter();
            
            // Show most recent gallop date by default
            const dates = Object.keys(gallopsByDate).sort((a, b) => new Date(b) - new Date(a));
            if (dates.length > 0) {
                document.getElementById('gallopDateFilter').value = dates[0];
                displayGallopsForDate(dates[0]);
            } else {
                document.getElementById('gallopTableBody').innerHTML = '<tr><td colspan="19" class="no-data">No gallops found.</td></tr>';
            }
            
        }

        function populateGallopDateFilter() {
            const select = document.getElementById('gallopDateFilter');
            select.innerHTML = '';
            
            const dates = Object.keys(gallopsByDate).sort((a, b) => new Date(b) - new Date(a));
            
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = new Date(date).toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                select.appendChild(option);
            });
        }

        function changeGallopDate() {
            const selectedDate = document.getElementById('gallopDateFilter').value;
            displayGallopsForDate(selectedDate);
        }

        function displayGallopsForDate(dateStr) {
            const gallops = gallopsByDate[dateStr] || [];
            const tbody = document.getElementById('gallopTableBody');
            
            // Update title with selected date
            const formattedDate = new Date(dateStr).toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('gallopViewTitle').textContent = `Comparaison des Galops - ${formattedDate}`;
            document.getElementById('gallopViewSubtitle').textContent = `${gallops.length} cheval${gallops.length === 1 ? '' : 'x'} ont galop√© ce jour`;
            
            if (gallops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" class="no-data">No gallops found for this date.</td></tr>';
                return;
            }
            
            // Sort gallops by current sort criteria
            gallops.sort((a, b) => {
                let aVal = a[currentGallopSort.column];
                let bVal = b[currentGallopSort.column];
                
                if (currentGallopSort.column === 'best5f' || currentGallopSort.column === 'best200m' || currentGallopSort.column === 'best800m') {
                    aVal = parseTimeToSeconds(aVal) || 999;
                    bVal = parseTimeToSeconds(bVal) || 999;
                } else if (currentGallopSort.column === 'fastRecovery' || currentGallopSort.column === 'recovery15min' || 
                         currentGallopSort.column === 'maxHeartRate' || currentGallopSort.column === 'heartRateReturn' ||
                         currentGallopSort.column === 'maxSpeed' || currentGallopSort.column === 'avgSpeed' ||
                         currentGallopSort.column === 'amplitude35' || currentGallopSort.column === 'effort1' ||
                         currentGallopSort.column === 'effort2' || currentGallopSort.column === 'effort3' ||
                         currentGallopSort.column === 'effort4' || currentGallopSort.column === 'effort5') {
                    aVal = parseFloat(aVal) || 999;
                    bVal = parseFloat(bVal) || 999;
                } else if (currentGallopSort.column === 'distance') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (currentGallopSort.column === 'group') {
                    // Apply the same group sorting logic as main table
                    const getGroupSortValue = (group) => {
                        if (group === '-') return 999;
                        if (group === 'A') return 1;
                        if (group === 'B') return 2;
                        if (group === 'C') return 3;
                        if (group.includes('/')) {
                            return getGroupSortValue(group.charAt(0));
                        }
                        return 500;
                    };
                    aVal = getGroupSortValue(getHorseGroup(a.horse));
                    bVal = getGroupSortValue(getHorseGroup(b.horse));
                }
                
                if (currentGallopSort.order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            tbody.innerHTML = '';
            gallops.forEach(gallop => {
                const row = document.createElement('tr');
                
                // Helper function to display values, replacing empty with '-'
                const displayValue = (value) => value && value !== 'N/C' ? value : '-';
                
                row.innerHTML = `
                    <td class="horse-name-col" style="font-weight: bold; text-align: left; cursor: pointer; width: 160px; min-width: 160px; white-space: nowrap;" onclick="goToHorseFromGallops('${gallop.horse}')">${gallop.horse}</td>
                    <td>${displayValue(gallop.age)}</td>
                    <td style="text-align: center; font-weight: bold;">${getHorseGroup(gallop.horse)}</td>
                    <td>${displayValue(gallop.distance)}</td>
                    <td>${displayValue(gallop.maxSpeed)}</td>
                    <td>${displayValue(gallop.avgSpeed)}</td>
                    <td>${displayValue(gallop.best200m)}</td>
                    <td>${displayValue(gallop.best800m)}</td>
                    <td style="background-color: ${get1000mTimeColor(gallop.best5f) || 'transparent'};">${displayValue(gallop.best5f)}</td>
                    <td>${displayValue(gallop.maxHeartRate)}</td>
                    <td style="background-color: ${getFastRecoveryColor(gallop.fastRecovery) || 'transparent'};">${displayValue(gallop.fastRecovery)}</td>
                    <td style="background-color: ${getRecovery15Color(gallop.recovery15min) || 'transparent'};">${displayValue(gallop.recovery15min)}</td>
                    <td>${displayValue(gallop.heartRateReturn)}</td>
                    <td>${displayValue(gallop.amplitude35)}</td>
                    <td>${displayValue(gallop.effort1)}</td>
                    <td>${displayValue(gallop.effort2)}</td>
                    <td>${displayValue(gallop.effort3)}</td>
                    <td>${displayValue(gallop.effort4)}</td>
                    <td>${displayValue(gallop.effort5)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function sortGallopTable(column) {
            if (currentGallopSort.column === column) {
                currentGallopSort.order = currentGallopSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentGallopSort.column = column;
                currentGallopSort.order = (column === 'best5f' || column === 'fastRecovery' || column === 'recovery15min') ? 'asc' : 'desc';
            }
            
            const selectedDate = document.getElementById('gallopDateFilter').value;
            displayGallopsForDate(selectedDate);
        }

        function goToHorseFromGallops(horseName) {
            // Save current gallop state
            navigationState.fromGallops = true;
            navigationState.gallopDate = document.getElementById('gallopDateFilter').value;
            
            // Show horse detail page
            showHorseDetail(horseName);
            
            // Update back button text
            updateBackButtonText();
        }

        function updateBackButtonText() {
            const backButton = document.querySelector('.horse-detail-view .back-button');
            if (backButton) {
                if (navigationState.fromGallops) {
                    backButton.textContent = '‚Üê Back to Gallops';
                } else {
                    backButton.textContent = '‚Üê Back to Main';
                }
            }
        }

        function backToMain() {
            // Check if we came from gallops page
            if (navigationState.fromGallops) {
                // Go back to gallops page
                navigationState.fromGallops = false;
                document.querySelector('.horse-detail-view').style.display = 'none';
                document.getElementById('gallopView').style.display = 'block';
                
                // Restore the previous gallop date selection
                if (navigationState.gallopDate) {
                    document.getElementById('gallopDateFilter').value = navigationState.gallopDate;
                    displayGallopsForDate(navigationState.gallopDate);
                }
            } else {
                // Normal back to main page
                document.getElementById('gallopView').style.display = 'none';
                document.querySelector('.horse-detail-view').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            }
        }
        
        function backToMainFromGallops() {
            document.getElementById('gallopView').style.display = 'none';
            document.querySelector('.horse-detail-view').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            navigationState.fromGallops = false;
        }

        function exportGallopsCsv() {
            const selectedDate = document.getElementById('gallopDateFilter').value;
            const gallops = gallopsByDate[selectedDate] || [];
            
            if (gallops.length === 0) {
                alert('No gallop data to export for this date.');
                return;
            }
            
            // Get formatted date for filename
            const formattedDate = new Date(selectedDate).toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            }).replace(/\//g, '-');
            
            // Create CSV headers (French)
            const headers = [
                'Cheval',
                '√Çge', 
                'Distance du travail',
                'Vitesse maximale',
                'Vitesse moyenne du travail',
                'Meilleurs 200m',
                'Meilleurs 800m', 
                'Meilleurs 1000m',
                'Fr√©quence cardiaque maximale atteinte',
                'R√©cup√©ration apr√®s l\'effort',
                '15 min r√©cup√©ration',
                'Fr√©quence cardiaque au retour',
                'Amplitude √† 35 km/h',
                'Temps zone effort 1',
                'Temps zone effort 2', 
                'Temps zone effort 3',
                'Temps zone effort 4',
                'Temps zone effort 5'
            ];
            
            // Sort gallops by current sort criteria
            const sortedGallops = [...gallops].sort((a, b) => {
                let aVal = a[currentGallopSort.column];
                let bVal = b[currentGallopSort.column];
                
                if (currentGallopSort.column === 'best5f' || currentGallopSort.column === 'best200m' || currentGallopSort.column === 'best800m') {
                    aVal = parseTimeToSeconds(aVal) || 999;
                    bVal = parseTimeToSeconds(bVal) || 999;
                } else if (currentGallopSort.column === 'fastRecovery' || currentGallopSort.column === 'recovery15min' || 
                         currentGallopSort.column === 'maxHeartRate' || currentGallopSort.column === 'heartRateReturn' ||
                         currentGallopSort.column === 'maxSpeed' || currentGallopSort.column === 'avgSpeed' ||
                         currentGallopSort.column === 'amplitude35' || currentGallopSort.column === 'effort1' ||
                         currentGallopSort.column === 'effort2' || currentGallopSort.column === 'effort3' ||
                         currentGallopSort.column === 'effort4' || currentGallopSort.column === 'effort5') {
                    aVal = parseFloat(aVal) || 999;
                    bVal = parseFloat(bVal) || 999;
                } else if (currentGallopSort.column === 'distance') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                if (currentGallopSort.order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            
            sortedGallops.forEach(gallop => {
                const displayValue = (value) => value && value !== 'N/C' ? value : '';
                
                const row = [
                    `"${gallop.horse}"`,
                    displayValue(gallop.age),
                    displayValue(gallop.distance),
                    displayValue(gallop.maxSpeed),
                    displayValue(gallop.avgSpeed),
                    formatTimeForExcel(displayValue(gallop.best200m)),
                    formatTimeForExcel(displayValue(gallop.best800m)),
                    formatTimeForExcel(displayValue(gallop.best5f)),
                    displayValue(gallop.maxHeartRate),
                    formatTimeForExcel(displayValue(gallop.fastRecovery)),
                    formatTimeForExcel(displayValue(gallop.recovery15min)),
                    displayValue(gallop.heartRateReturn),
                    displayValue(gallop.amplitude35),
                    formatTimeForExcel(displayValue(gallop.effort1)),
                    formatTimeForExcel(displayValue(gallop.effort2)),
                    formatTimeForExcel(displayValue(gallop.effort3)),
                    formatTimeForExcel(displayValue(gallop.effort4)),
                    formatTimeForExcel(displayValue(gallop.effort5))
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Gallops_${formattedDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        
    </script>
    
    <div class="lost-numbers">4 8 15 16 23 42</div>
</body>
</html>